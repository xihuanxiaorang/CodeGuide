---
title: ä»£ç†æ¨¡å¼
tags:
  - è®¾è®¡æ¨¡å¼ 
created: 2022-08-20 23:15:54
modified: 2022-10-14 04:37:47
number headings: auto, first-level 1, max 6, _.1.1.
---

# ä»£ç†æ¨¡å¼

## 1. ğŸ¨æ„å›¾

**ä»£ç†æ¨¡å¼** æ˜¯ä¸€ç§ **ç»“æ„å‹è®¾è®¡æ¨¡å¼**ï¼ŒÂ ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†å¯¹è±¡åœ¨å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹ä½œç”¨ã€‚  
ä½¿ç”¨ä»£ç†æ¨¡å¼ä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ï¼šä¸€æ˜¯ **ä¿æŠ¤ç›®æ ‡å¯¹è±¡**ï¼ŒäºŒæ˜¯ **å¢å¼ºç›®æ ‡å¯¹è±¡**ã€‚  
![|640](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006573.png)  

## 2. ğŸ¯ç»“æ„

![ä»£ç†æ¨¡å¼çš„ç±»ç»“æ„å›¾ | 400](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006054.svg)  

  

**Subject** æ˜¯ **é¡¶å±‚æ¥å£**ï¼Œ**RealSubject** æ˜¯ç›®æ ‡å¯¹è±¡ï¼ˆ**è¢«ä»£ç†å¯¹è±¡**ï¼‰ï¼Œ**Proxy** æ˜¯ **ä»£ç†å¯¹è±¡**ï¼Œ**ä»£ç†å¯¹è±¡æŒæœ‰è¢«ä»£ç†å¯¹è±¡çš„å¼•ç”¨**ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œåªä¸è¿‡ä¼šåœ¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ‰§è¡Œå‰åå¢åŠ ä¸€äº›å¤„ç†é€»è¾‘ã€‚  
æ³¨æ„ğŸ’¡ï¼š**ä»£ç†å¯¹è±¡ä¸è¢«ä»£ç†å¯¹è±¡å®ç°ç›¸åŒçš„æ¥å£**ï¼Œè¿™æ ·ä»£ç†å¯¹è±¡æ‰èƒ½ä¼ªè£…æˆè¢«ä»£ç†å¯¹è±¡ã€‚  

## 3. ğŸ‰åˆ†ç±»

- é™æ€ä»£ç†ï¼šåœ¨ç¨‹åºè¿è¡Œå‰å°±å·²ç»å­˜åœ¨ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œä»£ç†ç±»å’Œå§”æ‰˜ç±»çš„å…³ç³»åœ¨è¿è¡Œå‰å°±ç¡®å®šäº†ã€‚
- **åŠ¨æ€ä»£ç†**ï¼šç¼–è¯‘å®Œåæ²¡æœ‰ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œè€Œæ˜¯ **åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå¹¶åŠ è½½åˆ° JVM ä¸­**ã€‚

## 4. ğŸŠé™æ€ä»£ç†

### 4.1. ğŸ™é—®é¢˜

ä¸ºä»€ä¹ˆè¦æ§åˆ¶å¯¹äºæŸä¸ªå¯¹è±¡çš„è®¿é—®å‘¢ï¼ŸÂ ä¸¾ä¸ªä¾‹å­ï¼šÂ æœ‰è¿™æ ·ä¸€ä¸ªæ¶ˆè€—å¤§é‡ç³»ç»Ÿèµ„æºçš„å·¨å‹å¯¹è±¡ï¼ŒÂ ä½ åªæ˜¯å¶å°”éœ€è¦ä½¿ç”¨å®ƒï¼ŒÂ å¹¶éæ€»æ˜¯éœ€è¦ã€‚  
![|510](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006958.png)  
ä½ å¯ä»¥å®ç°å»¶è¿Ÿåˆå§‹åŒ–ï¼šåœ¨æœ‰éœ€è¦æ—¶å†åˆ›å»ºå¯¹è±¡ã€‚å¯¹è±¡çš„æ‰€æœ‰å®¢æˆ·ç«¯éƒ½è¦æ‰§è¡Œå»¶è¿Ÿåˆå§‹åŒ–ä»£ç ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™å¾ˆå¯èƒ½ä¼šå¸¦æ¥å¾ˆå¤šé‡å¤ä»£ç ã€‚  
åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå¸Œæœ›å°†ä»£ç ç›´æ¥æ”¾å…¥å¯¹è±¡çš„ç±»ä¸­ï¼Œä½†è¿™å¹¶éæ€»æ˜¯èƒ½å®ç°ï¼šæ¯”å¦‚ç±»å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹å°é—­åº“çš„ä¸€éƒ¨åˆ†ã€‚

### 4.2. ğŸ¥³è§£å†³æ–¹æ¡ˆ

ä»£ç†æ¨¡å¼å»ºè®®æ–°å»ºä¸€ä¸ªä¸ç›®æ ‡å¯¹è±¡æ¥å£ç›¸åŒçš„ä»£ç†ç±»ï¼Œç„¶åæ›´æ–°åº”ç”¨ä»¥å°†ä»£ç†å¯¹è±¡ç»™æ‰€æœ‰åŸå§‹å¯¹è±¡å®¢æˆ·ç«¯ã€‚ä»£ç†ç±»æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åä¼šåˆ›å»ºå®é™…çš„ç›®æ ‡å¯¹è±¡ï¼Œå¹¶å°†æ‰€æœ‰å·¥ä½œå§”æ´¾ç»™å®ƒã€‚  
![|510](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006642.png)  
ä»£ç†å°†è‡ªå·±ä¼ªè£…æˆæ•°æ®åº“å¯¹è±¡ï¼Œå¯åœ¨å®¢æˆ·ç«¯æˆ–å®é™…æ•°æ®åº“å¯¹è±¡ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å¤„ç†å»¶è¿Ÿåˆå§‹åŒ–å’Œç¼“å­˜æŸ¥è¯¢ç»“æœçš„å·¥ä½œã€‚  
è¿™æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿå¦‚æœéœ€è¦åœ¨ç±»çš„ä¸»è¦ä¸šåŠ¡é€»è¾‘å‰åæ‰§è¡Œä¸€äº›å·¥ä½œï¼Œæ— éœ€ä¿®æ”¹ç±»å°±èƒ½å®Œæˆè¿™é¡¹å·¥ä½œã€‚ç”±äº **ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£ä¸ç›®æ ‡å¯¹è±¡ç›¸åŒ**ï¼Œå› æ­¤å¯ä»¥å°†å…¶ä¼ é€’ç»™ä»»ä½•ä¸€ä¸ªä½¿ç”¨ç›®æ ‡å¯¹è±¡çš„å®¢æˆ·ç«¯ã€‚

### 4.3. ğŸš€æ¡ˆä¾‹åœºæ™¯

åœ¨åˆ†å¸ƒå¼ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œé€šå¸¸ä¼šå¯¹æ•°æ®åº“è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œåˆ†åº“åˆ†è¡¨ä¹‹åä½¿ç”¨ Java æ“ä½œæ—¶å°±å¯èƒ½éœ€è¦é…ç½®å¤šä¸ªæ•°æ®æºï¼Œæ­¤æ—¶é€šè¿‡è®¾ç½®æ•°æ®æºè·¯ç”±æ¥åŠ¨æ€åˆ‡æ¢æ•°æ®æºã€‚  

è®¢å•ç±»ï¼š

```java
@Data  
@NoArgsConstructor  
@AllArgsConstructor  
public class Order {  
    private Object orderInfo;  
    private Long createTime;  
    private String id;  
}
```

è®¢å•æŒä¹…å±‚æ“ä½œç±»ï¼š

```java
@Slf4j  
public class OrderDao {  
    public int insert(Order order) {  
        log.info("OrderDao åˆ›å»º Order æˆåŠŸï¼");  
        return 1;  
    }  
}
```

è®¢å•ä¸šåŠ¡å±‚æ¥å£ï¼š

```java
public interface OrderService {  
    /**  
     * åˆ›å»ºè®¢å•  
     *  
     * @param order è®¢å•  
     * @return æˆåŠŸä¸å¦  
     */  
    int createOrder(Order order);  
}
```

è®¢å•ä¸šåŠ¡å±‚æ¥å£å®ç°ç±»ï¼š

```java
@Slf4j  
public class OrderServiceImpl implements OrderService {  
    private final OrderDao orderDao = new OrderDao();  
  
    @Override  
    public int createOrder(Order order) {  
        log.info("OrderService è°ƒç”¨ orderDao åˆ›å»ºè®¢å•");  
        return orderDao.insert(order);  
    }  
}
```

æ¥ä¸‹æ¥ä½¿ç”¨é™æ€ä»£ç†ï¼Œä¸»è¦å®Œæˆçš„åŠŸèƒ½æ˜¯ï¼šæ ¹æ®è®¢å•åˆ›å»ºæ—¶é—´è‡ªåŠ¨æŒ‰å¹´ä»½è¿›è¡Œåˆ†åº“ã€‚  

æ•°æ®æºè·¯ç”±ï¼šä½¿ç”¨ ThreadLocal çš„å•ä¾‹å®ç°ã€‚

```java
public class DynamicDataSourceEntry {  
    private static final ThreadLocal<String> local = new ThreadLocal<>();  
  
    private DynamicDataSourceEntry() {  
    }  
    /**  
     * æ¸…ç©ºæ•°æ®æº  
     */  
    public static void clear() {  
        local.remove();  
    }  
  
    /**  
     * è·å–å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ•°æ®æºåç§°  
     *  
     * @return æ•°æ®æºåç§°  
     */  
    public static String get() {  
        return local.get();  
    }  
  
    /**  
     * è®¾ç½®å·²çŸ¥åå­—çš„æ•°æ®æº  
     *  
     * @param source æ•°æ®æºåç§°  
     */  
    public static void set(String source) {  
        local.set(source);  
    }  
  
    /**  
     * æ ¹æ®å¹´ä»½åŠ¨æ€è®¾ç½®æ•°æ®æº  
     *  
     * @param year å¹´ä»½  
     */  
    public static void set(int year) {  
        local.set("DB_" + year);  
    }  
}
```

è®¢å•ä¸šåŠ¡å±‚æ¥å£å®ç°ç±»çš„é™æ€ä»£ç†ç±»ï¼š

```java
@Slf4j  
public class OrderServiceStaticProxy implements OrderService {  
    private static final SimpleDateFormat yearFormatter = new SimpleDateFormat("yyyy");  
    private OrderService orderService;  
  
    public OrderServiceStaticProxy(OrderService orderService) {  
        this.orderService = orderService;  
    }  
  
    @Override  
    public int createOrder(Order order) {  
        before();  
        Long createTime = order.getCreateTime();  
        int dbRouter = Integer.parseInt(yearFormatter.format(new Date(createTime)));  
        log.info("é™æ€ä»£ç†ç±»è‡ªåŠ¨åˆ†é…åˆ°ã€DB_{}ã€‘æ•°æ®æºå¤„ç†æ•°æ®", dbRouter);  
        DynamicDataSourceEntry.set(dbRouter);  
        int res = orderService.createOrder(order);  
        after();  
        return res;  
    }  
  
    private void after() {  
        log.info("Proxy after method.");  
    }  
  
    private void before() {  
        log.info("Proxy before method.");  
    }  
}
```

æµ‹è¯•ç±»ï¼š

```java
public class OrderServiceStaticProxyTest {  
    @Test  
    public void test() {  
        try {  
            SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy/MM/dd");  
            Date date = simpleDateFormat.parse("2022/08/21");  
            Order order = new Order();  
            order.setCreateTime(date.getTime());  
  
            OrderServiceStaticProxy proxy = new OrderServiceStaticProxy(new OrderServiceImpl());  
            proxy.createOrder(order);  
        } catch (Exception e) {  
            throw new RuntimeException(e);  
        }  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
2022-08-21 23:16:46 INFO  OrderServiceStaticProxy:41 - Proxy before method.
2022-08-21 23:16:46 INFO  OrderServiceStaticProxy:29 - é™æ€ä»£ç†ç±»è‡ªåŠ¨åˆ†é…åˆ°ã€DB_2022ã€‘æ•°æ®æºå¤„ç†æ•°æ®
2022-08-21 23:16:46 INFO  OrderServiceImpl:18 - OrderService è°ƒç”¨ orderDao åˆ›å»ºè®¢å•
2022-08-21 23:16:46 INFO  OrderDao:15 - OrderDao åˆ›å»º Order æˆåŠŸï¼
2022-08-21 23:16:46 INFO  OrderServiceStaticProxy:37 - Proxy after method.
```

ç±»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š  
![ä»£ç†æ¨¡å¼-é™æ€ä»£ç†-åŠ¨æ€åˆ‡æ¢æ•°æ®æºæ¡ˆä¾‹ | 500](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006483.svg)  

## 5. ğŸåŠ¨æ€ä»£ç†

åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†çš„åŸºæœ¬æ€è·¯ä¸€è‡´ï¼Œåªä¸è¿‡åŠ¨æ€ä»£ç†åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œéšç€ä¸šåŠ¡çš„æ‰©å±•é€‚åº”æ€§æ›´å¼ºã€‚

### 5.1. JDK

#### 5.1.1. æ¡ˆä¾‹åœºæ™¯

å†æ¥çœ‹çœ‹ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç°æ•°æ®æºåŠ¨æ€è·¯ç”±ä¸šåŠ¡ã€‚åˆ›å»ºæµ‹è¯•ç±»ï¼š

```java
@Slf4j  
public class OrderServiceJDKDynamicProxyTest {  
    private static final SimpleDateFormat YYYY = new SimpleDateFormat("yyyy");  
    private static final SimpleDateFormat YYYY_MM_DD = new SimpleDateFormat("yyyy/MM/dd");  
  
    public static void main(String[] args) {  
        try {  
            Date date = YYYY_MM_DD.parse("2019/08/21");  
            Order order = new Order();  
            order.setCreateTime(date.getTime());  
  
            OrderService orderService = new OrderServiceImpl();  
            Class<?> clazz = orderService.getClass();  
  
            OrderService proxy = (OrderService) Proxy.newProxyInstance(clazz.getClassLoader(), clazz.getInterfaces(), new InvocationHandler() {  
                @Override  
                public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {  
                    try {  
                        before();  
                        Long createTime = (Long) clazz.getMethod("getCreateTime", Order.class).invoke(orderService, order);  
                        int dbRouter = Integer.parseInt(YYYY.format(new Date(createTime)));  
                        log.info("JDKåŠ¨æ€ä»£ç†ç±»è‡ªåŠ¨åˆ†é…åˆ°ã€DB_{}ã€‘æ•°æ®æºå¤„ç†æ•°æ®", dbRouter);  
                        DynamicDataSourceEntry.set(dbRouter);  
                        Object res = method.invoke(orderService, args);  
                        after();  
                        return res;  
                    } catch (Exception e) {  
                        e.printStackTrace();  
                    }  
                    return null;  
                }  
            });  
            proxy.createOrder(order);  
        } catch (Exception e) {  
            throw new RuntimeException(e);  
        }  
    }  
  
    private static void after() {  
        log.info("Proxy after method.");  
    }  
  
    private static void before() {  
        log.info("Proxy before method.");  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
2022-08-22 14:28:15 INFO  OrderServiceJDKDynamicProxyTest:67 - Proxy before method.
2022-08-22 14:28:15 INFO  OrderServiceJDKDynamicProxyTest:45 - JDKåŠ¨æ€ä»£ç†ç±»è‡ªåŠ¨åˆ†é…åˆ°ã€DB_2019ã€‘æ•°æ®æºå¤„ç†æ•°æ®
2022-08-22 14:28:15 INFO  OrderServiceImpl:18 - OrderService è°ƒç”¨ orderDao åˆ›å»ºè®¢å•
2022-08-22 14:28:15 INFO  OrderDao:15 - OrderDao åˆ›å»º Order æˆåŠŸï¼
2022-08-22 14:28:15 INFO  OrderServiceJDKDynamicProxyTest:63 - Proxy after method.
```

ä¾ç„¶èƒ½å¤Ÿè¾¾åˆ°ç›¸åŒçš„æ•ˆæœã€‚ä½†æ˜¯ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†ä¹‹åï¼Œä¸ä»…èƒ½å¤Ÿå®ç° Order çš„æ•°æ®æºåŠ¨æ€è·¯ç”±ï¼Œè¿˜å¯ä»¥å®ç°å…¶ä»–ä»»ä½•ç±»çš„æ•°æ®æºè·¯ç”±ã€‚å½“ç„¶ï¼Œæœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„çº¦å®šï¼Œå¿…é¡»å®ç° `getCreateTime` æ–¹æ³•ï¼Œå› ä¸ºè·¯ç”±è§„åˆ™æ˜¯æ ¹æ®æ—¶é—´æ¥è¿ç®—çš„ï¼Œå…¶å®å¯ä»¥é€šè¿‡æ¥å£è§„èŒƒæ¥è¾¾åˆ°çº¦æŸçš„ç›®çš„ã€‚

#### 5.1.2. æºç åˆ†æ

##### 5.1.2.1. æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»

åœ¨æµ‹è¯•ç±»çš„ main æ–¹æ³•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯ï¼Œè‡³äºåŸå› åœ¨åé¢çš„æºç åˆ†æä¸­ä¼šè¯´ã€‚

```java
System.setProperty("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");
```

ç‚¹å‡»è¿è¡Œå°±å¯ä»¥åœ¨å½“å‰é¡¹ç›®ç›®å½•ä¸‹æ‰¾åˆ°åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ class æ–‡ä»¶ã€‚  
  ![|300](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006786.png)  
JDK åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¦‚ä¸‹æ‰€ç¤ºï¼šå¯ä»¥çœ‹åˆ° **ä»£ç†ç±»ç»§æ‰¿è‡ª Proxy å¹¶ä¸”å®ç°äº†ä¸è¢«ä»£ç†ç±»ç›¸åŒçš„æ¥å£**ã€‚

```java
public final class $Proxy0 extends Proxy implements OrderService {  
    private static Method m1;  
    private static Method m3;  
    private static Method m2;  
    private static Method m4;  
    private static Method m0;  
  
    public $Proxy0(InvocationHandler var1) throws  {  
        super(var1);  
    }  
  
    public final boolean equals(Object var1) throws  {  
        try {  
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});  
        } catch (RuntimeException | Error var3) {  
            throw var3;  
        } catch (Throwable var4) {  
            throw new UndeclaredThrowableException(var4);  
        }  
    }  
  
    public final Long getCreateTime(Order var1) throws  {  
        try {  
            return (Long)super.h.invoke(this, m3, new Object[]{var1});  
        } catch (RuntimeException | Error var3) {  
            throw var3;  
        } catch (Throwable var4) {  
            throw new UndeclaredThrowableException(var4);  
        }  
    }  
  
    public final String toString() throws  {  
        try {  
            return (String)super.h.invoke(this, m2, (Object[])null);  
        } catch (RuntimeException | Error var2) {  
            throw var2;  
        } catch (Throwable var3) {  
            throw new UndeclaredThrowableException(var3);  
        }  
    }  
  
    public final int createOrder(Order var1) throws  {  
        try {  
            return (Integer)super.h.invoke(this, m4, new Object[]{var1});  
        } catch (RuntimeException | Error var3) {  
            throw var3;  
        } catch (Throwable var4) {  
            throw new UndeclaredThrowableException(var4);  
        }  
    }  
  
    public final int hashCode() throws  {  
        try {  
            return (Integer)super.h.invoke(this, m0, (Object[])null);  
        } catch (RuntimeException | Error var2) {  
            throw var2;  
        } catch (Throwable var3) {  
            throw new UndeclaredThrowableException(var3);  
        }  
    }  
  
    static {  
        try {  
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));  
            m3 = Class.forName("top.xiaorang.design.pattern.proxy.staticproxy.OrderService").getMethod("getCreateTime", Class.forName("top.xiaorang.design.pattern.proxy.staticproxy.Order"));  
            m2 = Class.forName("java.lang.Object").getMethod("toString");  
            m4 = Class.forName("top.xiaorang.design.pattern.proxy.staticproxy.OrderService").getMethod("createOrder", Class.forName("top.xiaorang.design.pattern.proxy.staticproxy.Order"));  
            m0 = Class.forName("java.lang.Object").getMethod("hashCode");  
        } catch (NoSuchMethodException var2) {  
            throw new NoSuchMethodError(var2.getMessage());  
        } catch (ClassNotFoundException var3) {  
            throw new NoClassDefFoundError(var3.getMessage());  
        }  
    }  
}
```

##### 5.1.2.2. ä»£ç†ç±»å¦‚ä½•ç”Ÿæˆï¼Ÿ

ä»ä¸Šé¢åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»æºç ä¸­çœ‹å‡ºï¼Œ**ç”Ÿæˆçš„ä»£ç†ç±»ç»§æ‰¿è‡ª `Proxy` ç±»**ã€‚  
å…¶ä¸­æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„ä¸€ä¸ªæ–¹æ³•å¯èƒ½å°±æ˜¯ **`newProxyInstance()`**ï¼Œ**ç”Ÿæˆå¹¶è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡**ã€‚åœ¨ `newProxyInstance()` æ–¹æ³•ä¸­æœ€ä¸ºå…³é”®çš„å‡ è¡Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public static Object newProxyInstance(ClassLoader loader, Class<?>[] interfaces,  
    InvocationHandler h) throws IllegalArgumentException {
	...
	// ç”Ÿæˆä»£ç†ç±»
	Class<?> cl = getProxyClass0(loader, intfs);
	// æ ¹æ®ä»£ç†ç±»è·å–æ„é€ æ–¹æ³•
	final Constructor<?> cons = cl.getConstructor(InvocationHandler.class);
	// é€šè¿‡ä»£ç†ç±»çš„æ„é€ å™¨åˆ›å»ºä»£ç†å¯¹è±¡å¹¶è¿”å›ï¼Œä¼ å…¥ InvocationHandler å‚æ•°    
	return cons.newInstance(new Object[]{h});  
	...
}
```

å…³äºåå°„å¦‚ä½•ä½¿ç”¨åœ¨æ­¤å¤„å°±ä¸å†èµ˜è¿°ã€‚æ­¤æ—¶å…³é”®ç‚¹å°±åœ¨äº **`getProxyClass0()`** æ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæˆä¸€ä¸ªä»£ç†ç±»çš„ï¼Ÿ 

```java
private static final WeakCache<ClassLoader, Class<?>[], Class<?>>  
    proxyClassCache = new WeakCache<>(new KeyFactory(), new ProxyClassFactory());

private static Class<?> getProxyClass0(ClassLoader loader, Class<?>... interfaces) {   
	// å¦‚æœç»™å®šåŠ è½½å™¨å®šä¹‰çš„ä»£ç†ç±»å®ç°ç»™å®šæ¥å£å­˜åœ¨ï¼Œè¿™å°†ç®€å•åœ°è¿”å›ç¼“å­˜çš„å‰¯æœ¬ï¼›å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡ä»£ç†ç±»å·¥å‚ ProxyClassFactory åˆ›å»ºä»£ç†ç±»
	return proxyClassCache.get(loader, interfaces);  
}
```

æ¥åˆ° `WeakCache` ç±»çš„ `get()` æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public V get(K key, P parameter) {  
    Objects.requireNonNull(parameter);  
    expungeStaleEntries();  
    Object cacheKey = CacheKey.valueOf(key, refQueue);  
  
    // é€šè¿‡ç±»åŠ è½½å™¨,è·å–å·²åŠ è½½è¿‡çš„æ¥å£å…ƒæ•°æ®å’Œä»£ç†ç±»å·¥å‚(ProxyClassFactory)
    // å…¶ä¸­ï¼Œmapä¸­çš„key = æ¥å£å…ƒæ•°æ®ï¼Œvalue = ä»£ç†ç±»å·¥å‚(ä½œç”¨: åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡)
    ConcurrentMap<Object, Supplier<V>> valuesMap = map.get(cacheKey);
    // åˆå§‹åŒ–æ“ä½œï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„Map  
    if (valuesMap == null) {  
        ConcurrentMap<Object, Supplier<V>> oldValuesMap  
            = map.putIfAbsent(cacheKey,  
                              valuesMap = new ConcurrentHashMap<>());  
        if (oldValuesMap != null) {  
            valuesMap = oldValuesMap;  
        }  
    }  
  
    // å°†æ‰€æœ‰æ¥å£è¿›è¡Œhashç”Ÿæˆå”¯ä¸€æ ‡è¯†   
    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter)); 
    // é€šè¿‡å”¯ä¸€æ ‡è¯†å°è¯•æ€§è·å–ä»£ç†ç±»å·¥å‚(ProxyClassFactory) 
    Supplier<V> supplier = valuesMap.get(subKey);  
    Factory factory = null;  
  
    while (true) {
	    // ç¬¬ä¸€æ¬¡å¹¶ä¸å­˜åœ¨ä»£ç†ç±»å·¥å‚ï¼Œæ‰€ä»¥ä¸æ»¡è¶³æ¡ä»¶ï¼Œèµ°ä¸‹é¢çš„ä»£ç ç”Ÿæˆä»£ç†ç±»å·¥å‚ï¼Œç¬¬ä¸€æ¬¡å¾ªç¯ç»“æŸã€‚ç¬¬äºŒæ¬¡æ‰ä¼šæ»¡è¶³æ¡ä»¶  
        if (supplier != null) {  
            // ä»ä»£ç†ç±»å·¥å‚ä¸­è·å–ä»£ç†ç±»å¹¶è¿”å›
            V value = supplier.get();  
            if (value != null) {  
                return value;  
            }  
        }  
        // åˆ›å»ºä¸€ä¸ªä»£ç†ç±»å·¥å‚       
        if (factory == null) {  
            factory = new Factory(key, parameter, subKey, valuesMap);  
        }  
  
        if (supplier == null) {
	        // å°†ä»£ç†ç±»å·¥å‚æ”¾å…¥ç¼“å­˜ä¸­  
            supplier = valuesMap.putIfAbsent(subKey, factory);  
            if (supplier == null) {  
                // å·²ç»åˆ›å»ºå¥½ä»£ç†ç±»å·¥å‚ï¼Œä¸ºç¬¬äºŒæ¬¡å¾ªç¯åšå‡†å¤‡ï¼Œåœ¨ç¬¬äºŒæ¬¡å¾ªç¯æ—¶ï¼Œå¯ä»¥é€šè¿‡ä»£ç†ç±»å·¥å‚è·å–ä»£ç†ç±» 
                supplier = factory;  
            }  
        } else {
	        // ä»£ç†ç±»å·¥å‚çš„é‡è¯•æœºåˆ¶
	        // å½“ä»ä»£ç†ç±»å·¥å‚ä¸­è·å–å‡ºçš„ä»£ç†ç±»ä¸ºç©ºæ—¶ï¼Œåˆ™ç”¨æ–°åˆ›å»ºçš„ä»£ç†ç±»å·¥å‚æ›¿æ¢æ‰ç¼“å­˜ä¸­æ—§çš„ä»£ç†ç±»å·¥å‚
	        // ç„¶åå†ç”¨æ–°çš„ä»£ç†ç±»å·¥å‚å»åˆ›å»ºä»£ç†ç±»
            if (valuesMap.replace(subKey, supplier, factory)) {  
                supplier = factory;  
            } else {  
                supplier = valuesMap.get(subKey);  
            }  
        }  
    }  
}
```

###### 5.1.2.2.1. ç»†èŠ‚åˆ†æ 1ï¼šProxy.KeyFactory

ä½œç”¨ï¼šé€šè¿‡æ‰€æœ‰çš„æ¥å£è¿›è¡Œ hash æ“ä½œç”Ÿæˆå”¯ä¸€æ ‡è¯†ç”¨æ¥å¯¹åº”ä»£ç†ç±»å·¥å‚ã€‚

```java
private static final class KeyFactory implements BiFunction<ClassLoader, Class<?>[], Object> {  
    @Override  
    public Object apply(ClassLoader classLoader, Class<?>[] interfaces) {  
        switch (interfaces.length) {  
            case 1: return new Key1(interfaces[0]); // the most frequent  
            case 2: return new Key2(interfaces[0], interfaces[1]);  
            case 0: return key0;  
            default: return new KeyX(interfaces);  
        }  
    }  
}
```

###### 5.1.2.2.2. ç»†èŠ‚åˆ†æ 2ï¼šProxy.ProxyClassFactory

ä½œç”¨ï¼šçœŸæ­£ **ç”Ÿæˆä»£ç†ç±»** çš„åœ°æ–¹ã€‚

```java
private static final class ProxyClassFactory implements BiFunction<ClassLoader, Class<?>[], Class<?>> {  
    // æ‰€æœ‰ä»£ç†ç±»åç§°çš„å‰ç¼€ 
    private static final String proxyClassNamePrefix = "$Proxy";  
  
    // ç”¨äºç”Ÿæˆå”¯ä¸€ä»£ç†ç±»åç§°çš„ä¸‹ä¸€ä¸ªæ•°å­—  
    private static final AtomicLong nextUniqueNumber = new AtomicLong();
    
	@Override
	public Class<?> apply(ClassLoader loader, Class<?>[] interfaces) {
		// è¦ç”Ÿæˆçš„ä»£ç†ç±»çš„åç§°
	    long num = nextUniqueNumber.getAndIncrement();  
	    String proxyName = proxyPkg + proxyClassNamePrefix + num;
	    // ç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶.å³$Proxy.class  
	    byte[] proxyClassFile = ProxyGenerator.generateProxyClass(proxyName, interfaces, accessFlags);  
	    try { 
		    // å°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°JVMè™šæ‹Ÿæœºå†…å­˜ä¸­ï¼Œè¿”å›ç”Ÿæˆçš„ä»£ç†ç±» 
	        return defineClass0(loader, proxyName, proxyClassFile, 0, proxyClassFile.length);  
	    } catch (ClassFormatError e) {  
	        throw new IllegalArgumentException(e.toString());  
	    }  
	}
}
```

###### 5.1.2.2.3. ç»†èŠ‚åˆ†æ 3ï¼šProxyGenerator

åœ¨è¯¥ç±»ä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ–¹æ³• **`generateProxyClass`**ï¼Œ**ç”Ÿæˆå¹¶è¿”å›ä»£ç†ç±»çš„å­—èŠ‚ç ä¿¡æ¯**ã€‚å¦‚æœ `saveGeneratedFiles` æ ‡è¯†ä¸º trueï¼Œå³ JVM å‚æ•° `sun.misc.ProxyGenerator.saveGeneratedFiles` ä¸º true çš„è¯ï¼ˆè¿™ä¹Ÿå°±æ˜¯ä¸Šé¢æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»ä¸­ä¸ºå•¥è¦åŠ è¯¥ JVM å‚æ•°çš„åŸå› ï¼‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ I/O æµå°†å­—èŠ‚ç ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ `$Proxy{num}.class` ä¸­ã€‚

```java
private static final boolean saveGeneratedFiles = (Boolean)AccessController.doPrivileged(new GetBooleanAction("sun.misc.ProxyGenerator.saveGeneratedFiles"));

public static byte[] generateProxyClass(final String var0, Class<?>[] var1, int var2) {  
    ProxyGenerator var3 = new ProxyGenerator(var0, var1, var2); 
    // ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œè¿”å›å­—èŠ‚æ•°ç»„
    final byte[] var4 = var3.generateClassFile();
    // å°†ç”Ÿæˆçš„å­—èŠ‚ç ,ä½¿ç”¨I/Oæµä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶  
    if (saveGeneratedFiles) {  
        AccessController.doPrivileged(new PrivilegedAction<Void>() {  
            public Void run() {  
                try {  
                    int var1 = var0.lastIndexOf(46);  
                    Path var2;  
                    if (var1 > 0) {  
                        Path var3 = Paths.get(var0.substring(0, var1).replace('.', File.separatorChar));  
                        Files.createDirectories(var3);  
                        var2 = var3.resolve(var0.substring(var1 + 1, var0.length()) + ".class");  
                    } else {  
                        var2 = Paths.get(var0 + ".class");  
                    }  
  
                    Files.write(var2, var4, new OpenOption[0]);  
                    return null;                } catch (IOException var4x) {  
                    throw new InternalError("I/O exception saving generated file: " + var4x);  
                }  
            }  
        });  
    }  
    return var4;  
}
```

è‡³äº `ProxyGenerator` ç±»ä¸­çš„ `generateClassFile()` æ–¹æ³•æ˜¯å¦‚ä½•ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶çš„ï¼Œæ­¤å¤„æ¶‰åŠåˆ° JVM å†…å­˜å’Œå­—èŠ‚ç è§„èŒƒæ–¹é¢çš„çŸ¥è¯†ç‚¹ï¼Œç­‰ä»¥åæœ‰æœºä¼šå†å›è¿‡å¤´æ¥å®Œå–„ (å…¶å®å°±æ˜¯ç°åœ¨ä¸ä¼šğŸ˜“)ã€‚  
å‚è€ƒé“¾æ¥ï¼š[# JDKåŠ¨æ€ä»£ç†æºç åˆ†æ: åˆ°ç”Ÿæˆå­—èŠ‚ç ](https://www.bilibili.com/video/BV1t44y1B77P?share_source=copy_pc)ï¼Œé…å¥—æ–‡ç« ï¼š[# jdkåŠ¨æ€ä»£ç†: ä»æºç ,åˆ°å­—èŠ‚ç ,åˆ°è‡ªå·±æ‰‹å†™åŠ¨æ€ä»£ç†](https://mp.weixin.qq.com/s/1zOufG4oonTKlwAo0Bs17Q)

##### 5.1.2.3. ä½¿ç”¨ä»£ç†ç±»çš„æ•´ä½“æµç¨‹

åœ¨ä¸Šé¢æ¡ˆä¾‹çš„æµ‹è¯•ç±»ä»£ç ä¸­ï¼Œæœ‰è¿™æ ·ä¸€å¥ä»£ç  `orderService.createOrder(order);`ï¼Œè°ƒç”¨ä»£ç†ç±»ä¸­çš„ `createOrder()` æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å†æ¥çœ‹çœ‹ä»£ç†ç±»ä¸­ `createOrder()` æ–¹æ³•çš„å…·ä½“å®ç°ã€‚

```java
public final int createOrder(Order var1) throws  {  
	try {  
		return (Integer)super.h.invoke(this, m4, new Object[]{var1});  
	} catch (RuntimeException | Error var3) {  
		throw var3;  
	} catch (Throwable var4) {  
		throw new UndeclaredThrowableException(var4);  
	}  
} 
```

ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ**è°ƒç”¨äº†çˆ¶ç±» `Proxy` ä¸­ `InvocationHandler` æ¥å£æˆå‘˜å˜é‡çš„ `invoke()` æ–¹æ³•**(ä¹Ÿå°±æ˜¯æˆ‘ä»¬é‡å†™çš„ `invoke()` æ–¹æ³•)ã€‚  
ä¼ å…¥çš„å‚æ•°ä¾æ¬¡æ˜¯ã€ä»£ç†ç±»æœ¬èº«ã€‘ï¼Œ`createOrder()` æ–¹æ³•çš„ `Method` å¯¹è±¡ã€‘ï¼Œã€`createOrder()` æ–¹æ³•çš„å…¥å‚ã€‘ã€‚  
å…¶ä¸­ï¼Œæœ‰ä¸€ä¸ªå…³é”®çš„ç‚¹åœ¨äºæˆ‘ä»¬ä½¿ç”¨ Proxy ç±»ä¸­çš„ `newProxyInstance()` æ–¹æ³•æ—¶ï¼Œåˆ©ç”¨ä»£ç†ç±»çš„æ„é€ å™¨åˆ›å»ºä»£ç†ç±»å¯¹è±¡æ—¶ï¼Œæ„é€ å™¨ä¼ å…¥çš„å‚æ•°ä¸º InvocationHandler å®ç°ã€‚

```java
public $Proxy0(InvocationHandler var1) throws  {  
	super(var1);  
} 
```

åœ¨ä»£ç†ç±»çš„æ„é€ å™¨ä¸­ï¼Œåˆè°ƒç”¨çˆ¶ç±»çš„æ„é€ å™¨ï¼Œå°† `InvocationHandler` å®ç°ä¼ ç»™çˆ¶ç±»ï¼Œè®© `InvocationHandler` æ¥å£çš„æˆå‘˜å˜é‡ `h` æ¥æ”¶ï¼Œæ‰€ä»¥ä»£ç†ç±»çš„ `createOrder()` æ‰å¯ä»¥ç›´æ¥æ‰§è¡Œçˆ¶ç±»ä¸­æˆå‘˜å˜é‡ `h` çš„ `invoke()` æ–¹æ³•ã€‚  
è¿™å°±æ˜¯ä»£ç†ç±»æ‰§è¡Œçš„æ•´ä¸ªæµç¨‹ï¼Œä»ç”Ÿæˆä»£ç†ç±»ï¼Œåˆ°ä½¿ç”¨ä»£ç†ç±»ã€‚

### 5.2. Cglib

cglib å³ Code Generation Libraryï¼ŒåšåŠ¨æ€ä»£ç†å…¶å®åªæ˜¯ cglib ä¸€æ–¹é¢çš„åº”ç”¨ã€‚å…¶å® cglib æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„é«˜æ€§èƒ½é«˜è´¨é‡ä»£ç ç”Ÿæˆåº“ï¼Œå®ƒåº•å±‚ä¾èµ–äºå°è€Œå¿«çš„ **å­—èŠ‚ç å¤„ç†æ¡†æ¶ ASM**ï¼Œæ¥æ‰©å±• JAVA ç±»å¹¶åœ¨è¿è¡Œæ—¶å®ç°æ¥å£ã€‚

#### 5.2.1. æ¡ˆä¾‹åœºæ™¯

å†æ¥çœ‹çœ‹ä½¿ç”¨ Cglib åŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç°æ•°æ®æºåŠ¨æ€è·¯ç”±ä¸šåŠ¡ã€‚åˆ›å»ºæµ‹è¯•ç±»ï¼š

```java
@Slf4j  
public class OrderServiceCglibDynamicProxyTest {  
    private static final SimpleDateFormat YYYY = new SimpleDateFormat("yyyy");  
    private static final SimpleDateFormat YYYY_MM_DD = new SimpleDateFormat("yyyy/MM/dd");  
  
    public static void main(String[] args) {  
        try {  
            Date date = YYYY_MM_DD.parse("2019/08/21");  
            Order order = new Order();  
            order.setCreateTime(date.getTime());  
  
            OrderService orderService = new OrderServiceImpl();  
            Class<?> clazz = orderService.getClass();  
  
            Enhancer enhancer = new Enhancer();  
            enhancer.setSuperclass(clazz);  
            enhancer.setCallback((MethodInterceptor) (o, method, objects, methodProxy) -> {  
                try {  
                    before();  
                    Long createTime = (Long) clazz.getMethod("getCreateTime", Order.class).invoke(orderService, order);  
                    int dbRouter = Integer.parseInt(YYYY.format(new Date(createTime)));  
                    log.info("CglibåŠ¨æ€ä»£ç†ç±»è‡ªåŠ¨åˆ†é…åˆ°ã€DB_{}ã€‘æ•°æ®æºå¤„ç†æ•°æ®", dbRouter);  
                    DynamicDataSourceEntry.set(dbRouter);  
                    Object res = methodProxy.invokeSuper(o, objects);  
                    after();  
                    return res;  
                } catch (Exception e) {  
                    e.printStackTrace();  
                }  
                return null;  
            });  
            OrderService proxy = (OrderService) enhancer.create();  
            proxy.createOrder(order);  
        } catch (Exception e) {  
            throw new RuntimeException(e);  
        }  
    }  
  
    private static void after() {  
        log.info("Proxy after method.");  
    }  
  
    private static void before() {  
        log.info("Proxy before method.");  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

```
2022-08-22 14:54:35 INFO  OrderServiceCglibDynamicProxyTest:64 - Proxy before method.
2022-08-22 14:54:35 INFO  OrderServiceCglibDynamicProxyTest:42 - CglibåŠ¨æ€ä»£ç†ç±»è‡ªåŠ¨åˆ†é…åˆ°ã€DB_2019ã€‘æ•°æ®æºå¤„ç†æ•°æ®
2022-08-22 14:54:35 INFO  OrderServiceImpl:18 - OrderService è°ƒç”¨ orderDao åˆ›å»ºè®¢å•
2022-08-22 14:54:35 INFO  OrderDao:15 - OrderDao åˆ›å»º Order æˆåŠŸï¼
2022-08-22 14:54:35 INFO  OrderServiceCglibDynamicProxyTest:60 - Proxy after method.
```

#### 5.2.2. æºç åˆ†æ

##### 5.2.2.1. æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç†ç±»

åœ¨æµ‹è¯•ç±»çš„ main æ–¹æ³•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å³å¯ï¼Œè‡³äºåŸå› åœ¨åé¢çš„æºç åˆ†æä¸­ä¼šè¯´ã€‚

```java
System.setProperty(DEBUG_LOCATION_PROPERTY, new File("").getAbsolutePath() + "/cglib");
```

ç‚¹å‡»è¿è¡Œå°±å¯ä»¥åœ¨å½“å‰é¡¹ç›®ç›®å½•ä¸‹çš„ cglib ç›®å½•ä¸­æ‰¾åˆ°åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ class æ–‡ä»¶ã€‚  
![|800](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140007958.png)  
å¯ä»¥çœ‹åˆ°ä¸ JDK ç”Ÿæˆçš„ä»£ç†ç±»ä¸åŒçš„æ˜¯ï¼ŒCglib ç”Ÿæˆçš„ class æ–‡ä»¶æœ‰ä¸‰ä¸ªï¼Œä¾æ¬¡å¾€ä¸‹åˆ†åˆ«æ˜¯ã€**ä»£ç†ç±»**ã€‘ã€ã€**ä»£ç†ç±»çš„ FastClass ç±»**ã€‘å’Œã€**è¢«ä»£ç†ç±»çš„ FastClass ç±»**ã€‘ã€‚  
Cglib åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¦‚ä¸‹æ‰€ç¤º (æˆªå–éƒ¨åˆ†é‡è¦çš„ä»£ç )ï¼šå¯ä»¥çœ‹åˆ° **ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ç»§æ‰¿è‡ªè¢«ä»£ç†ç±»** çš„ã€‚  éœ€è¦æ³¨æ„çš„æ˜¯ğŸ’¡ï¼š**è¢« `final` ä¿®é¥°çš„ç±»å’Œæ–¹æ³•éƒ½ä¸å¯è¢«ä»£ç†**ã€‚

```java
public class OrderServiceImpl$$EnhancerByCGLIB$$346db491 extends OrderServiceImpl implements Factory {  
    private static final ThreadLocal CGLIB$THREAD_CALLBACKS;  
    private static final Callback[] CGLIB$STATIC_CALLBACKS;  
    private MethodInterceptor CGLIB$CALLBACK_0;  
    private static final Method CGLIB$getCreateTime$0$Method;  
    private static final MethodProxy CGLIB$getCreateTime$0$Proxy;  
    private static final Object[] CGLIB$emptyArgs;  
    private static final Method CGLIB$createOrder$1$Method;  
    private static final MethodProxy CGLIB$createOrder$1$Proxy;  
  
    static void CGLIB$STATICHOOK1() {  
        CGLIB$THREAD_CALLBACKS = new ThreadLocal();  
        CGLIB$emptyArgs = new Object[0];
        // var0 = ä»£ç†ç±»  
        Class var0 = Class.forName("top.xiaorang.design.pattern.proxy.basic.OrderServiceImpl$$EnhancerByCGLIB$$346db491");
        // var1 = è¢«ä»£ç†ç±»  
        Class var1;  
        var10000 = ReflectUtils.findMethods(new String[]{"getCreateTime", "(Ltop/xiaorang/design/pattern/proxy/basic/Order;)Ljava/lang/Long;", "createOrder", "(Ltop/xiaorang/design/pattern/proxy/basic/Order;)I"}, (var1 = Class.forName("top.xiaorang.design.pattern.proxy.basic.OrderServiceImpl")).getDeclaredMethods());  
        CGLIB$createOrder$1$Method = var10000[1];  
        CGLIB$createOrder$1$Proxy = MethodProxy.create(var1, var0, "(Ltop/xiaorang/design/pattern/proxy/basic/Order;)I", "createOrder", "CGLIB$createOrder$1");  
    }     
  
    final int CGLIB$createOrder$1(Order var1) {  
        return super.createOrder(var1);  
    }  
  
    public final int createOrder(Order var1) {  
        MethodInterceptor var10000 = this.CGLIB$CALLBACK_0;  
        if (var10000 == null) {  
            CGLIB$BIND_CALLBACKS(this);  
            var10000 = this.CGLIB$CALLBACK_0;  
        }  
        if (var10000 != null) {  
            Object var2 = var10000.intercept(this, CGLIB$createOrder$1$Method, new Object[]{var1}, CGLIB$createOrder$1$Proxy);  
            return var2 == null ? 0 : ((Number)var2).intValue();  
        } else {  
            return super.createOrder(var1);  
        }  
    }  
  
    public static MethodProxy CGLIB$findMethodProxy(Signature var0) {  
        String var10000 = var0.toString();  
        switch (var10000.hashCode()) {  
            case -921643372:  
                if (var10000.equals("getCreateTime(Ltop/xiaorang/design/pattern/proxy/basic/Order;)Ljava/lang/Long;")) {  
                    return CGLIB$getCreateTime$0$Proxy;  
                }  
                break;  
            case -508378822:  
                if (var10000.equals("clone()Ljava/lang/Object;")) {  
                    return CGLIB$clone$5$Proxy;  
                }  
                break;  
            case 1159457639:  
                if (var10000.equals("createOrder(Ltop/xiaorang/design/pattern/proxy/basic/Order;)I")) {  
                    return CGLIB$createOrder$1$Proxy;  
                }  
                break;  
            case 1826985398:  
                if (var10000.equals("equals(Ljava/lang/Object;)Z")) {  
                    return CGLIB$equals$2$Proxy;  
                }  
                break;  
            case 1913648695:  
                if (var10000.equals("toString()Ljava/lang/String;")) {  
                    return CGLIB$toString$3$Proxy;  
                }  
                break;  
            case 1984935277:  
                if (var10000.equals("hashCode()I")) {  
                    return CGLIB$hashCode$4$Proxy;  
                }  
        }  
  
        return null;  
    }  

	// ä»£ç†ç±»çš„æ„é€ æ–¹æ³•
    public OrderServiceImpl$$EnhancerByCGLIB$$346db491() {  
        CGLIB$BIND_CALLBACKS(this);  
    }  
  
    public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) {  
        CGLIB$THREAD_CALLBACKS.set(var0);  
    }  
  
    private static final void CGLIB$BIND_CALLBACKS(Object var0) {  
        OrderServiceImpl$$EnhancerByCGLIB$$346db491 var1 = (OrderServiceImpl$$EnhancerByCGLIB$$346db491)var0;  
        // åˆå§‹åŒ–æ“ä½œï¼Œåªæ‰§è¡Œä¸€æ¬¡
        if (!var1.CGLIB$BOUND) {  
            var1.CGLIB$BOUND = true;  
            // ä» ThreadLocal ä¸­è·å– CALLBACKS
            Object var10000 = CGLIB$THREAD_CALLBACKS.get();  
            if (var10000 == null) {
	            // å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨ CGLIB$STATIC_CALLBACKS  
                var10000 = CGLIB$STATIC_CALLBACKS;  
                if (var10000 == null) {  
                    return;  
                }  
            }  
		    // CALLBACKSä¸­çš„ç¬¬ä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨èµ‹å€¼ç»™ CGLIB$CALLBACK_0
            var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0];  
        }  
  
    } 
  
    static {  
        CGLIB$STATICHOOK1();  
    }  
}
```

###### 5.2.2.1.1. ç»†èŠ‚åˆ†æ 1ï¼šåˆå§‹åŒ–æ“ä½œ

åœ¨ä»£ç†ç±»çš„ **é™æ€ä»£ç å—** ä¸­ï¼Œè°ƒç”¨ **`CGLIB$STATICHOOK1()`** æ–¹æ³•æ‰§è¡Œå¤§é‡çš„ **åˆå§‹åŒ–** æ“ä½œã€‚å…¶ä¸­æœ€å€¼å¾—å…³æ³¨çš„æ˜¯ä½¿ç”¨ `MethodProxy` ç±»çš„ `create()` æ–¹æ³•åˆ›å»º `MethodProxy` å®ä¾‹ï¼Œç„¶åèµ‹å€¼ç»™ `CGLIB$createOrder$1$Proxy` ï¼Œæ–¹æ³•å…¥å‚ä¾æ¬¡åˆ†åˆ«æ˜¯ã€è¢«ä»£ç†ç±»ã€‘ã€ã€ä»£ç†ç±»ã€‘ã€ã€è¢«ä»£ç†æ–¹æ³•è¿”å›å€¼çš„æè¿°ä¿¡æ¯ã€‘ã€ã€è¢«ä»£ç†ç±»ä¸­çš„ `createOrder` æ–¹æ³•åç§° ã€‘å’Œã€ä»£ç†ç±»ä¸­çš„ `CGLIB$createOrder$1` æ–¹æ³•åç§° ã€‘ã€‚

```java
public static MethodProxy create(Class c1, Class c2, String desc, String name1, String name2) {  
    MethodProxy proxy = new MethodProxy();  
    proxy.sig1 = new Signature(name1, desc); // è¢«ä»£ç†ç±»ä¸­çš„æ–¹æ³•ç­¾å => void createOrder()  
    proxy.sig2 = new Signature(name2, desc); // ä»£ç†ç±»ä¸­çš„æ–¹æ³•ç­¾å => void CGLIB$createOrder$1()   
    proxy.createInfo = new CreateInfo(c1, c2); // createInfoç”¨äºä¿å­˜è¢«ä»£ç†ç±»å’Œä»£ç†ç±»çš„ä¿¡æ¯   
    return proxy;  
}

private static class CreateInfo {  
    Class c1;  
    Class c2;  
    NamingPolicy namingPolicy;  
    GeneratorStrategy strategy;  
    boolean attemptLoad;  
  
    public CreateInfo(Class c1, Class c2) {  
        this.c1 = c1;  
        this.c2 = c2;  
        AbstractClassGenerator fromEnhancer = AbstractClassGenerator.getCurrent();  
        if (fromEnhancer != null) {  
            this.namingPolicy = fromEnhancer.getNamingPolicy();  
            this.strategy = fromEnhancer.getStrategy();  
            this.attemptLoad = fromEnhancer.getAttemptLoad();  
        }  
  
    }  
}
```

###### 5.2.2.1.2. ç»†èŠ‚åˆ†æ 2ï¼šcreateOrder() æ–¹æ³•

å¯ä»¥çœ‹åˆ°ï¼Œè¢«ä»£ç†ç±»ä¸­çš„æ¯ä¸ªæ–¹æ³•åœ¨ä»£ç†ç±»ä¸­éƒ½æœ‰ä¸¤ä¸ªï¼š

- å…¶ä¸­ä¸€ä¸ªæ–¹æ³•æ˜¯ `CGLIB$createOrder$1()` ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨çˆ¶ç±» (å³è¢«ä»£ç†ç±») ä¸­çš„ `cerateOrder()`ï¼›
- å¦ä¸€ä¸ªæ–¹æ³•å°±æ˜¯ `createOrder()` ï¼Œè¯¥æ–¹æ³•æ¯”è¾ƒé‡è¦ï¼Œç”¨äºæ‰§è¡ŒåŸå§‹æ–¹æ³•å¢å¼ºé€»è¾‘ã€‚  

åœ¨è°ƒç”¨ä»£ç†ç±»çš„ `createOrder()` æ—¶ï¼Œé¦–å…ˆä¼šåˆ¤æ–­æ–¹æ³•æ‹¦æˆªå™¨ç±»å‹çš„ `CGLIB$CALLBACK_0` å˜é‡æ˜¯å¦ä¸º nullï¼Œå¦‚æœä¸º null çš„è¯ï¼Œåˆ™è°ƒç”¨ `CGLIB$BIND_CALLBACKS()` æ–¹æ³•æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå…¥å‚ä¸ºå½“å‰ä»£ç†ç±»ï¼Œåœ¨ `CGLIB$BIND_CALLBACKS()` æ–¹æ³•ä¸­ä¼šä» ThreadLoacl ç±»å‹çš„ `CGLIB$THREAD_CALLBACKS` å˜é‡ä¸­å–å‡ºç¬¬ä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨èµ‹å€¼ç»™ `CGLIB$CALLBACK_0`ã€‚å¦‚æœä¸ä¸º null çš„è¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨æ–¹æ³•æ‹¦æˆªå™¨çš„ `intercept()` æ–¹æ³• (ä¹Ÿå°±æ˜¯åœ¨æµ‹è¯•ç±»ä¸­æˆ‘ä»¬é‡å†™è¿‡çš„ `intercept()` æ–¹æ³•)ï¼Œå…¥å‚ä¾æ¬¡åˆ†åˆ«æ˜¯ã€å½“å‰ä»£ç†ç±»ã€‘ã€ã€è¢«ä»£ç†ç±»ä¸­çš„å½“å‰æ–¹æ³•ã€‘ã€ã€`createOrder()` æ–¹æ³•çš„å…¥å‚ã€‘å’Œã€`CGLIB$createOrder$1$Proxy` (ç»†èŠ‚åˆ†æ 1ï¼šåˆå§‹åŒ–æ“ä½œä¸­å°±æ˜¯é’ˆå¯¹è¯¥å˜é‡)ã€‘ã€‚  
åœ¨ä¸Šé¢æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ğŸ’¡ï¼š `CGLIB$THREAD_CALLBACKS` å˜é‡æ˜¯ä½•æ—¶èµ‹å€¼çš„ï¼Ÿ  
åœ¨æµ‹è¯•ç±»ä»£ç ä¸­ï¼Œ**è°ƒç”¨ `Enhancer` ç±»ä¸­çš„ `create()` æ–¹æ³•è·å–ä»£ç†å¯¹è±¡**ã€‚åœ¨ `create()` æ–¹æ³•ä¸­ä¼šç»è¿‡ä¸€ç³»åˆ—å¤æ‚é€»è¾‘ (åœ¨è¿™æœŸé—´å·²ç»åˆ›å»ºå¥½äº†ä»£ç†ç±»)ï¼Œè°ƒç”¨åˆ°çˆ¶ç±» `AbstractClassGenerator` ä¸­çš„æŠ½è±¡æ–¹æ³• `nextInstance()`ï¼Œè¯¥æ–¹æ³•åˆè¢«å­ç±» `Enhancer` é‡å†™ï¼Œå…œå…œè½¬è½¬ï¼Œèµ‹å€¼çš„é€»è¾‘æœ€ç»ˆæ¥åˆ° `Enhancer` ç±»ä¸­çš„ `nextInstance()` æ–¹æ³•ã€‚

```java
protected Object nextInstance(Object instance) {  
    EnhancerFactoryData data = (EnhancerFactoryData) instance;  
  
    if (classOnly) {  
        return data.generatedClass;  
    }  
  
    Class[] argumentTypes = this.argumentTypes;  
    Object[] arguments = this.arguments;  
    if (argumentTypes == null) {  
        argumentTypes = Constants.EMPTY_CLASS_ARRAY;  
        arguments = null;  
    }  
    return data.newInstance(argumentTypes, arguments, callbacks);  
}
```

åœ¨ `newInstance()` æ–¹æ³•ä¸­ï¼Œé™¤äº†é€šè¿‡åå°„çš„æ–¹å¼åˆ›å»ºä»£ç†ç±»å¯¹è±¡å¹¶è¿”å›ä¹‹å¤–ï¼ŒåŒæ—¶è¿˜é€šè¿‡åå°„çš„æ–¹å¼è°ƒç”¨ä»£ç†ç±»ä¸­çš„ `CGLIB$SET_THREAD_CALLBACKS` æ–¹æ³•ç»™ `CGLIB$THREAD_CALLBACKS` å˜é‡èµ‹å€¼ã€‚

```java
public Object newInstance(Class[] argumentTypes, Object[] arguments, Callback[] callbacks) {
    setThreadCallbacks(callbacks);  
    try {  
        if (primaryConstructorArgTypes == argumentTypes ||  
                Arrays.equals(primaryConstructorArgTypes, argumentTypes)) {  
            return ReflectUtils.newInstance(primaryConstructor, arguments);  
        }
        return ReflectUtils.newInstance(generatedClass, argumentTypes, arguments);  
    } finally {  
        setThreadCallbacks(null);  
    }  
}  
  
private void setThreadCallbacks(Callback[] callbacks) {  
    try {  
        setThreadCallbacks.invoke(generatedClass, (Object) callbacks);  
    } catch (IllegalAccessException e) {  
        throw new CodeGenerationException(e);  
    } catch (InvocationTargetException e) {  
        throw new CodeGenerationException(e.getTargetException());  
    }  
}
```

##### 5.2.2.2. ä»£ç†ç±»å¦‚ä½•ç”Ÿæˆï¼Ÿ

å¯ä»¥è¿½è¸ªåˆ° `Enhancer` ç±»çš„çˆ¶ç±» `AbstractClassGenerator` ä¸­çš„ `ClassLoaderData()` æ–¹æ³•ã€‚

```java
public ClassLoaderData(ClassLoader classLoader) {  
    if (classLoader == null) {  
        throw new IllegalArgumentException("classLoader == null is not yet supported");  
    }  
    this.classLoader = new WeakReference<ClassLoader>(classLoader);  
    Function<AbstractClassGenerator, Object> load =  
            new Function<AbstractClassGenerator, Object>() {  
                public Object apply(AbstractClassGenerator gen) {  
                    Class klass = gen.generate(ClassLoaderData.this);  
                    return gen.wrapCachedClass(klass);  
                }  
            };  
    generatedClasses = new LoadingCache<AbstractClassGenerator, Object, Object>(GET_KEY, load);  
}
```

åœ¨ `ClassLoaderData()` æ–¹æ³•ä¸­åˆä½¿ç”¨åˆ°æœ¬ç±»çš„å¦ä¸€ä¸ªæ–¹æ³• `generate()`ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæ ¸å¿ƒçš„ä»£ç é€»è¾‘ä¸º **ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶å’Œå°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ° JVM ä¸­**ã€‚æ­¤å¤„æ¶‰åŠåˆ° ASM æŠ€æœ¯æ–¹é¢çš„çŸ¥è¯†ç‚¹ï¼Œç­‰ä»¥åæœ‰æœºä¼šå†å›è¿‡å¤´æ¥å®Œå–„ (å…¶å®å°±æ˜¯ç°åœ¨ä¸ä¼šğŸ˜“)ã€‚ 

```java
protected Class generate(ClassLoaderData data) {  
    try {  
        byte[] b = strategy.generate(this);  
        String className = ClassNameReader.getClassName(new ClassReader(b));  
        ProtectionDomain protectionDomain = getProtectionDomain();  
        synchronized (classLoader) { 
            if (protectionDomain == null) {  
                gen = ReflectUtils.defineClass(className, b, classLoader);  
            } else {  
                gen = ReflectUtils.defineClass(className, b, classLoader, protectionDomain);  
            }  
        }  
        return gen;  
    } catch (RuntimeException e) {  
        throw e;  
    } catch (Error e) {  
        throw e;  
    } catch (Exception e) {  
        throw new CodeGenerationException(e);  
    } finally {  
        CURRENT.set(save);  
    }  
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ğŸ’¡ï¼Œæ­¤å¤„é™¤äº†å¯ä»¥ç”¨äº **ç”Ÿæˆä»£ç†ç±»** ä¹‹å¤–ï¼Œè¿˜èƒ½ç”¨äº **ç”Ÿæˆä»£ç†ç±»çš„ FastClass ç±»ã€è¢«ä»£ç†ç±»çš„ FastClass ç±»** (ä¹Ÿå°±æ˜¯å’±ä»¬æˆªå›¾çœ‹åˆ°çš„ä¸‰ä¸ª class æ–‡ä»¶)ã€‚ä¸è¿‡ **`FastClass` å¹¶ä¸æ˜¯è·Ÿä»£ç†ç±»ä¸€èµ·ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ `MethodProxy` çš„ `invoke()` æˆ– `invokeSuper()` æ–¹æ³•æ—¶ç”Ÿæˆçš„ï¼Œå¹¶æ”¾åœ¨äº†ç¼“å­˜ä¸­**ã€‚

##### 5.2.2.3. FastClass

åœ¨æµ‹è¯•ç±»é‡å†™çš„æ–¹æ³•æ‹¦æˆªå™¨ä¸­ï¼Œæœ‰è¿™æ ·ä¸€è¡Œä»£ç ï¼Œ`Object res = methodProxy.invokeSuper(o, objects);` è°ƒç”¨ `methodProxy` çš„ `invokeSuper()` æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°ä¾æ¬¡åˆ†åˆ«æ˜¯ã€ä»£ç†ç±»å¯¹è±¡ã€‘å’Œã€è¢«ä»£ç†ç±»ä¸­è¯¥æ–¹æ³•æ‰€éœ€çš„å‚æ•°ã€‘ã€‚  è‡³äºåœ¨ã€ç»†èŠ‚åˆ†æ 1ï¼šåˆå§‹åŒ–æ“ä½œã€‘ä¸­å·²ç»ç»™ `methodProxy` è¿›è¡Œåˆå§‹åŒ–ï¼Œé‚£å°±ä¸»è¦çœ‹çœ‹ `invokeSuper()` æ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘ï¼š

```java
public Object invokeSuper(Object obj, Object[] args) throws Throwable {  
    try {  
        init();  
        FastClassInfo fci = fastClassInfo;  
        return fci.f2.invoke(fci.i2, obj, args);  
    } catch (InvocationTargetException e) {  
        throw e.getTargetException();  
    }  
}
```

åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šè°ƒç”¨ `init()` æ–¹æ³•ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¯¥æ–¹æ³• **ä½¿ç”¨åŒé‡æ£€æŸ¥é”çš„æ–¹å¼æ¥åˆ›å»º fastClassInfo å•ä¾‹å¯¹è±¡**ã€‚

```java
private void init() {  
	if (fastClassInfo == null) {  
		synchronized (initLock) {  
			if (fastClassInfo == null) {
				// createInfo ä¿å­˜äº†è¢«ä»£ç†ç±»å’Œä»£ç†ç±»çš„ä¿¡æ¯  
				CreateInfo ci = createInfo;  
				// åˆ›å»ºä¸€ä¸ª FastClassInfo å¯¹è±¡
				FastClassInfo fci = new FastClassInfo(); 
				// åˆ›å»ºè¢«ä»£ç†ç±»çš„FastClassç±»å¯¹è±¡ => OrderServiceImpl$$FastClassByCGLIB$$81a41a87 
				fci.f1 = helper(ci, ci.c1);
				// åˆ›å»ºä»£ç†ç±»çš„FastClassç±»å¯¹è±¡ => OrderServiceImpl$$EnhancerByCGLIB$$346db491$$FastClassByCGLIB$$d0660f18  
				fci.f2 = helper(ci, ci.c2);
				
				// åœ¨åˆ›å»ºä»£ç†ç±»çš„FastClasså’Œè¢«ä»£ç†ç±»çš„FastClassæ—¶å°±å·²ç»äº‹å…ˆä¸ºæ¯ä¸ªæ–¹æ³•æ ¹æ®å…¶æ–¹æ³•ç­¾åç”Ÿæˆäº†ä¸€ä¸ªä¸‹æ ‡ä»¥åŠæ¯ä¸ªä¸‹æ ‡æ‰€è¦æ‰§è¡Œçš„æ–¹æ³•
				// è°ƒç”¨æ—¶ç›´æ¥é€šè¿‡ä¸‹æ ‡å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œæ€§èƒ½ä¸å°±æå‡äº†å˜›ï¼
				
				// f1ä¸ºè¢«ä»£ç†ç±»çš„FastClassç±»å¯¹è±¡ï¼Œæ­¤æ—¶è°ƒç”¨è¯¥å¯¹è±¡çš„ getIndex æ–¹æ³•ï¼Œæ ¹æ®æ–¹æ³•ç­¾åsig1ã€void createOrder()ã€‘è·å–å¯¹åº”çš„ä¸‹æ ‡   
				fci.i1 = fci.f1.getIndex(sig1);
				// f2ä¸ºä»£ç†ç±»çš„FastClassç±»å¯¹è±¡ï¼Œæ­¤æ—¶è°ƒç”¨è¯¥å¯¹è±¡çš„ getIndex æ–¹æ³•ï¼Œæ ¹æ®æ–¹æ³•ç­¾åsig2ã€void CGLIB$createOrder$1()ã€‘è·å–å¯¹åº”çš„ä¸‹æ ‡  
				fci.i2 = fci.f2.getIndex(sig2);  
				fastClassInfo = fci;  
				createInfo = null;  
			}  
		}  
	}  
}
```

æ‰§è¡Œå®Œ `init()` æ–¹æ³•ä¹‹åï¼Œç´§æ¥ç€å¼€å§‹æ‰§è¡Œ `fci.f2.invoke(fci.i2, obj, args);` ä»£ç ã€‚åœ¨ `init()` æ–¹æ³•ä¸­å·²ç»çŸ¥é“ï¼Œf2 ä¸ºä»£ç†ç±»çš„ FastClass ç±»å¯¹è±¡ï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„ `invoke()` æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°ä¾æ¬¡åˆ†åˆ«æ˜¯ã€ä»£ç†ç±»ä¸­æ–¹æ³•ç­¾å `void CGLIB$createOrder$1()` å¯¹åº”çš„ä¸‹æ ‡ã€‘ã€ã€ä»£ç†ç±»å¯¹è±¡ã€‘å’Œã€`CGLIB$createOrder$1()` æ–¹æ³•æ‰€éœ€è¦çš„å‚æ•°ã€‘ã€‚

```java
public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException {  
    OrderServiceImpl..EnhancerByCGLIB..346db491 var10000 = (OrderServiceImpl..EnhancerByCGLIB..346db491)var2;  
    int var10001 = var1;  
    try {  
        switch (var10001) {
	        ...  
            case 20:  
			    return new Integer(var10000.CGLIB$createOrder$1((Order)var3[0]));
			...
		}  
    } catch (Throwable var4) {  
        throw new InvocationTargetException(var4);  
    }  
    throw new IllegalArgumentException("Cannot find matching method/constructor");  
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ğŸ’¡ï¼š**å¦‚æœ `invokeSuper()` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºã€è¢«ä»£ç†ç±»å¯¹è±¡ã€‘ï¼Œåˆ™ä¼šæŠ›å‡ºè½¬æ¢å¼‚å¸¸ï¼Œæ— æ³•å°†è¢«ä»£ç†ç±»å¼ºè½¬æˆä»£ç†ç±»ï¼Œå› ä¸ºè¢«ä»£ç†ç±»æ˜¯çˆ¶ç±»**ã€‚

------

å‰é¢å·²ç»åˆ†æè¿‡ `MethodProxy` ç±»ä¸­çš„ `invokeSuper()` æ–¹æ³•ä¸­çš„é€»è¾‘ï¼Œå†æ¥çœ‹çœ‹ `invoke()` æ–¹æ³•ã€‚

```java
public Object invoke(Object obj, Object[] args) throws Throwable {  
    try {  
        init();  
        FastClassInfo fci = fastClassInfo;  
        return fci.f1.invoke(fci.i1, obj, args);  
    } catch (InvocationTargetException e) {  
        throw e.getTargetException();  
    } catch (IllegalArgumentException e) {  
        if (fastClassInfo.i1 < 0)  
            throw new IllegalArgumentException("Protected method: " + sig1);  
        throw e;  
    }  
}
```

ä¸ `invokeSuper()` æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯å…ˆæ‰§è¡Œ `init()` æ–¹æ³•ï¼Œåªä¸è¿‡æ¥ä¸‹æ¥æ‰§è¡Œçš„æ˜¯ `fci.f1.invoke(fci.i1, obj, args);` ä»£ç ã€‚åœ¨ `init()` æ–¹æ³•ä¸­å·²ç»çŸ¥é“ï¼Œf1 ä¸ºè¢«ä»£ç†ç±»çš„ FastClass ç±»å¯¹è±¡ï¼Œè°ƒç”¨è¯¥å¯¹è±¡çš„ `invoke()` æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°ä¾æ¬¡åˆ†åˆ«æ˜¯ã€è¢«ä»£ç†ç±»ä¸­æ–¹æ³•ç­¾å `void createOrder()` å¯¹åº”çš„ä¸‹æ ‡ã€‘ã€ã€è¢«ä»£ç†ç±»å¯¹è±¡ã€‘å’Œã€`createOrder()` æ–¹æ³•æ‰€éœ€è¦çš„å‚æ•°ã€‘ã€‚

```java
public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException {  
    OrderServiceImpl var10000 = (OrderServiceImpl)var2;  
    int var10001 = var1;  
  
    try {  
        switch (var10001) {
	        ...  
            case 0:  
                return new Integer(var10000.createOrder((Order)var3[0]));  
            ...  
        }  
    } catch (Throwable var4) {  
        throw new InvocationTargetException(var4);  
    }  
  
    throw new IllegalArgumentException("Cannot find matching method/constructor");  
}
```

éœ€è¦æ³¨æ„çš„æ˜¯ğŸ’¡ï¼š**å¦‚æœ `invoke()` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºã€ä»£ç†ç±»å¯¹è±¡ã€‘ï¼Œä¼šå‡ºç°å †æ ˆæº¢å‡ºï¼Œå› ä¸ºä¼šè°ƒç”¨ä»£ç†ç±»ä¸­çš„ `cerateOrder()` æ–¹æ³•ï¼Œ `cerateOrder()` æ–¹æ³•åˆä¼šè°ƒç”¨ `intercept()` æ–¹æ³•ï¼Œè€Œåœ¨ `intercept()` æ–¹æ³•ä¸­åˆä¼šè°ƒç”¨ `invoke()` æ–¹æ³•ï¼Œç›´æ¥é™·å…¥æ­»å¾ªç¯**ã€‚  

### 5.3. Cglib ä¸ JDK åŠ¨æ€ä»£ç†å¯¹æ¯”

1. **JDK åŠ¨æ€ä»£ç†å®ç°äº†è¢«ä»£ç†å¯¹è±¡çš„æ¥å£**ï¼Œ**Cglib ä»£ç†ç»§æ‰¿äº†è¢«ä»£ç†å¯¹è±¡**ã€‚
2. JDK åŠ¨æ€ä»£ç†ä¸ Cglib åŠ¨æ€ä»£ç†éƒ½æ˜¯åœ¨è¿è¡ŒæœŸç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼ŒJDK åŠ¨æ€ä»£ç†ç›´æ¥å†™ Class å­—èŠ‚ç ï¼ŒCglib åŠ¨æ€ä»£ç†ä½¿ç”¨ ASM æ¡†æ¶å†™ Class å­—èŠ‚ç ï¼ŒCglib åŠ¨æ€ä»£ç†å®ç°æ›´å¤æ‚ï¼Œç”Ÿæˆä»£ç†ç±»æ¯” JDK åŠ¨æ€ä»£ç†æ•ˆç‡ä½ã€‚
3. **JDK åŠ¨æ€ä»£ç†è°ƒç”¨ä»£ç†æ–¹æ³•æ˜¯é€šè¿‡åå°„æœºåˆ¶è°ƒç”¨çš„**ï¼Œ**Cglib ä»£ç†æ˜¯é€šè¿‡ FastClass æœºåˆ¶ç›´æ¥è°ƒç”¨æ–¹æ³•çš„**ã€‚åœ¨ JDK8 ç‰ˆæœ¬ä¹‹åï¼ŒJDK åŠ¨æ€ä»£ç†çš„æ•ˆç‡æ˜¯é«˜äº Cglib çš„ï¼Œéšç€æ¯ä¸€æ¬¡ JDK ç‰ˆæœ¬å‡çº§ï¼ŒJDK åŠ¨æ€ä»£ç†æ•ˆç‡éƒ½æœ‰æ‰€æå‡ï¼Œè€Œ Cglib åˆ™æœ‰ç‚¹è·Ÿä¸ä¸Šæ­¥ä¼äº†ã€‚
