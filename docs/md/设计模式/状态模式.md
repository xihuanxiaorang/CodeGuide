---
title: çŠ¶æ€æ¨¡å¼
tags:
  - è®¾è®¡æ¨¡å¼ 
created: 2022-10-09 02:45:32
modified: 2022-10-17 07:07:47
number headings: auto, first-level 1, max 6, _.1.1.
---

## 1. ğŸ¨æ„å›¾

**çŠ¶æ€æ¨¡å¼** æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œè®©ä½ èƒ½åœ¨ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å˜åŒ–æ—¶æ”¹å˜å…¶è¡Œä¸ºï¼Œä½¿å…¶çœ‹ä¸Šå»å°±åƒæ”¹å˜äº†è‡ªèº«æ‰€å±çš„ç±»ä¸€æ ·ã€‚  
![|640](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358674.png)

## 2. ğŸ™é—®é¢˜

çŠ¶æ€æ¨¡å¼ä¸ **æœ‰é™çŠ¶æ€æœº**Â çš„æ¦‚å¿µç´§å¯†ç›¸å…³ã€‚  
![æœ‰é™çŠ¶æ€æœº|320](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358050.png)  
å…¶ä¸»è¦æ€æƒ³æ˜¯ç¨‹åºåœ¨ä»»æ„æ—¶åˆ»ä»…å¯å¤„åœ¨å‡ ç§ **æœ‰é™** çš„ **çŠ¶æ€** ä¸­ã€‚åœ¨ä»»ä½•ä¸€ä¸ªç‰¹å®šçŠ¶æ€ä¸­ï¼Œç¨‹åºçš„è¡Œä¸ºéƒ½ä¸ç›¸åŒï¼Œä¸”å¯ç¬é—´ä»ä¸€ä¸ªçŠ¶æ€åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€ã€‚ä¸è¿‡ï¼Œæ ¹æ®å½“å‰çŠ¶æ€ï¼Œç¨‹åºå¯èƒ½ä¼šåˆ‡æ¢åˆ°å¦å¤–ä¸€ç§çŠ¶æ€ï¼Œä¹Ÿå¯èƒ½ä¼šä¿æŒå½“å‰çŠ¶æ€ä¸å˜ã€‚è¿™äº›æ•°é‡æœ‰é™ä¸”é¢„å…ˆå®šä¹‰çš„çŠ¶æ€åˆ‡æ¢è§„åˆ™è¢«ç§°ä¸º **è½¬ç§»**ã€‚  
ä½ è¿˜å¯å°†è¯¥æ–¹æ³•åº”ç”¨åœ¨å¯¹è±¡ä¸Šã€‚å‡å¦‚ä½ æœ‰ä¸€ä¸ªæœ‰ä¸€ä¸ªÂ `Document` æ–‡æ¡£ç±»ã€‚æ–‡æ¡£å¯èƒ½ä¼šå¤„äº `Draft` è‰ç¨¿ã€`Moderation` å®¡é˜…ä¸­å’Œ `Published` å·²å‘å¸ƒä¸‰ç§çŠ¶æ€çš„ä¸€ç§ã€‚æ–‡æ¡£çš„ `publish` å‘å¸ƒæ–¹æ³•åœ¨ä¸åŒçŠ¶æ€çš„è¡Œä¸ºç•¥æœ‰ä¸åŒï¼š

- å¤„äº `è‰ç¨¿` çŠ¶æ€æ—¶ï¼Œå®ƒä¼šå°†æ–‡æ¡£è½¬ç§»åˆ°å®¡é˜…ä¸­çŠ¶æ€ã€‚
- å¤„äº `å®¡é˜…ä¸­` çŠ¶æ€æ—¶ï¼Œå¦‚æœå½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œå®ƒä¼šå…¬å¼€å‘å¸ƒæ–‡æ¡£ã€‚
- å¤„äº `å·²å‘å¸ƒ` çŠ¶æ€æ—¶ï¼Œå®ƒä¸ä¼šè¿›è¡Œä»»ä½•æ“ä½œã€‚  
![æ–‡æ¡£å¯¹è±¡çš„å…¨éƒ¨çŠ¶æ€å’Œè½¬ç§»|370](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358212.png)  
çŠ¶æ€æœºé€šå¸¸ç”±ä¼—å¤šæ¡ä»¶è¿ç®—ç¬¦ï¼ˆ`if` æˆ– `switch`ï¼‰å®ç°ï¼Œå¯æ ¹æ®å¯¹è±¡çš„å½“å‰çŠ¶æ€é€‰æ‹©ç›¸åº”çš„è¡Œä¸ºã€‚â€çŠ¶æ€â€œé€šå¸¸åªæ˜¯å¯¹è±¡ä¸­çš„ä¸€ç»„æˆå‘˜å˜é‡å€¼ã€‚å³ä½¿ä½ ä¹‹å‰ä»æœªå¬è¯´è¿‡æœ‰é™çŠ¶æ€æœºï¼Œä½ ä¹Ÿå¾ˆå¯èƒ½å·²ç»å®ç°è¿‡çŠ¶æ€æ¨¡å¼ã€‚ä¸‹é¢çš„ä»£ç åº”è¯¥èƒ½å¸®åŠ©ä½ å›å¿†èµ·æ¥ã€‚

```java
class Document is
    field state: string
    // â€¦â€¦
    method publish() is
        switch (state)
            "draft":
                state = "moderation"
                break
            "moderation":
                if (currentUser.role == "admin")
                    state = "published"
                break
            "published":
                // ä»€ä¹ˆä¹Ÿä¸åšã€‚
                break
    // â€¦â€¦
```

å½“æˆ‘ä»¬é€æ­¥åœ¨ `æ–‡æ¡£` ç±»ä¸­æ·»åŠ æ›´å¤šçŠ¶æ€å’Œä¾èµ–äºçŠ¶æ€çš„è¡Œä¸ºåï¼ŒåŸºäºæ¡ä»¶è¯­å¥çš„çŠ¶æ€æœºå°±ä¼šæš´éœ²å…¶æœ€å¤§çš„å¼±ç‚¹ã€‚ä¸ºäº†èƒ½æ ¹æ®å½“å‰çŠ¶æ€é€‰æ‹©å®Œæˆç›¸åº”è¡Œä¸ºçš„æ–¹æ³•ï¼Œç»å¤§éƒ¨åˆ†æ–¹æ³•ä¸­ä¼šåŒ…å«å¤æ‚çš„æ¡ä»¶è¯­å¥ã€‚ä¿®æ”¹å…¶è½¬æ¢é€»è¾‘å¯èƒ½ä¼šæ¶‰åŠåˆ°ä¿®æ”¹æ‰€æœ‰æ–¹æ³•ä¸­çš„çŠ¶æ€æ¡ä»¶è¯­å¥ï¼Œå¯¼è‡´ä»£ç çš„ç»´æŠ¤å·¥ä½œéå¸¸è‰°éš¾ã€‚  
è¿™ä¸ªé—®é¢˜ä¼šéšç€é¡¹ç›®è¿›è¡Œå˜å¾—è¶Šå‘ä¸¥é‡ã€‚æˆ‘ä»¬å¾ˆéš¾åœ¨è®¾è®¡é˜¶æ®µé¢„æµ‹åˆ°æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€å’Œè½¬æ¢ã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œæœ€åˆä»…åŒ…å«æœ‰é™æ¡ä»¶è¯­å¥çš„ç®€æ´çŠ¶æ€æœºå¯èƒ½ä¼šå˜æˆè‡ƒè‚¿çš„ä¸€å›¢ä¹±ç ã€‚

## 3. ğŸ¥³è§£å†³æ–¹æ¡ˆ

**çŠ¶æ€æ¨¡å¼** å»ºè®® **å¯¹è±¡çš„æ‰€æœ‰å¯èƒ½çŠ¶æ€æ–°å»ºä¸€ä¸ªç±»**ï¼Œç„¶å **å°†æ‰€æœ‰çŠ¶æ€çš„å¯¹åº”è¡Œä¸ºæŠ½å–åˆ°è¿™äº›ç±»ä¸­**ã€‚  
**åŸå§‹å¯¹è±¡** è¢«ç§°ä¸º **ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰**ï¼Œ**å®ƒå¹¶ä¸ä¼šè‡ªè¡Œå®ç°æ‰€æœ‰è¡Œä¸º**ï¼Œè€Œæ˜¯ä¼š **ä¿å­˜ä¸€ä¸ªæŒ‡å‘è¡¨ç¤ºå½“å‰çŠ¶æ€çš„çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œä¸”å°†æ‰€æœ‰ä¸çŠ¶æ€ç›¸å…³çš„å·¥ä½œå§”æ´¾ç»™è¯¥å¯¹è±¡**ã€‚  
![æ–‡æ¡£å°†å·¥ä½œå§”æ´¾ç»™ä¸€ä¸ªçŠ¶æ€å¯¹è±¡|490](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358327.png)  
å¦‚éœ€ **å°†ä¸Šä¸‹æ–‡è½¬æ¢ä¸ºå¦å¤–ä¸€ç§çŠ¶æ€**ï¼Œåˆ™éœ€ **å°†å½“å‰æ´»åŠ¨çš„çŠ¶æ€å¯¹è±¡æ›¿æ¢ä¸ºå¦å¤–ä¸€ä¸ªä»£è¡¨æ–°çŠ¶æ€çš„å¯¹è±¡**ã€‚é‡‡ç”¨è¿™ç§æ–¹å¼æ˜¯æœ‰å‰æçš„ï¼š**æ‰€æœ‰çŠ¶æ€ç±»éƒ½å¿…é¡»éµå¾ªåŒæ ·çš„æ¥å£ï¼Œè€Œä¸”ä¸Šä¸‹æ–‡å¿…é¡»ä»…é€šè¿‡æ¥å£ä¸è¿™äº›å¯¹è±¡è¿›è¡Œäº¤äº’**ã€‚  
è¿™ä¸ªç»“æ„å¯èƒ½çœ‹ä¸Šå»ä¸ç­–ç•¥æ¨¡å¼ç›¸ä¼¼ï¼Œä½†æœ‰ä¸€ä¸ªå…³é”®æ€§çš„ä¸åŒ -- åœ¨çŠ¶æ€æ¨¡å¼ä¸­ï¼Œç‰¹å®šçŠ¶æ€çŸ¥é“å…¶ä»–æ‰€æœ‰çŠ¶æ€çš„å­˜åœ¨ï¼Œä¸”èƒ½è§¦å‘ä»ä¸€ä¸ªçŠ¶æ€åˆ°å¦ä¸€ä¸ªçŠ¶æ€çš„è½¬æ¢ï¼›ç­–ç•¥æ¨¡å¼åˆ™å‡ ä¹å®Œå…¨ä¸çŸ¥é“å…¶ä»–ç­–ç•¥çš„å­˜åœ¨ã€‚

## 4. ğŸš—çœŸå®ä¸–ç•Œç±»æ¯”

æ™ºèƒ½æ‰‹æœºçš„æŒ‰é”®å’Œå¼€å…³ä¼šæ ¹æ®è®¾å¤‡å½“å‰çŠ¶æ€å®Œæˆä¸åŒè¡Œä¸ºï¼š

- å½“æ‰‹æœºå¤„äºè§£é”çŠ¶æ€æ—¶ï¼ŒæŒ‰ä¸‹æŒ‰é”®å°†æ‰§è¡Œå„ç§åŠŸèƒ½ã€‚
- å½“æ‰‹æœºå¤„äºé”å®šçŠ¶æ€æ—¶ï¼ŒæŒ‰ä¸‹ä»»ä½•æŒ‰é”®éƒ½å°†è§£é”å±å¹•ã€‚
- å½“æ‰‹æœºç”µé‡ä¸è¶³æ—¶ï¼ŒæŒ‰ä¸‹ä»»ä½•æŒ‰é”®éƒ½å°†æ˜¾ç¤ºå……ç”µé¡µé¢ã€‚

## 5. ğŸ¯ç»“æ„

![|588](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358248.png)

1. **ä¸Šä¸‹æ–‡**ï¼ˆContextï¼‰**ä¿å­˜äº†å¯¹äºä¸€ä¸ªå…·ä½“çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶ä¼šå°†æ‰€æœ‰ä¸è¯¥çŠ¶æ€ç›¸å…³çš„å·¥ä½œå§”æ´¾ç»™å®ƒ**ã€‚ä¸Šä¸‹æ–‡é€šè¿‡çŠ¶æ€æ¥å£ä¸çŠ¶æ€å¯¹è±¡äº¤äº’ï¼Œä¸”ä¼š **æä¾›ä¸€ä¸ªè®¾ç½®å™¨ç”¨äºä¼ é€’æ–°çš„çŠ¶æ€å¯¹è±¡**ã€‚
2. **çŠ¶æ€**ï¼ˆStateï¼‰æ¥å£ä¼šå£°æ˜ç‰¹å®šäºçŠ¶æ€çš„æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•åº”èƒ½è¢«å…¶ä»–å…·ä½“çŠ¶æ€æ‰€ç†è§£ï¼Œå› ä¸ºä½ ä¸å¸Œæœ›æŸäº›çŠ¶æ€æ‰€æ‹¥æœ‰çš„æ–¹æ³•æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨ã€‚
3. **å…·ä½“çŠ¶æ€**ï¼ˆConcrete Statesï¼‰ä¼šè‡ªè¡Œå®ç°ç‰¹å®šäºçŠ¶æ€çš„æ–¹æ³•ã€‚ä¸ºäº†é¿å…å¤šä¸ªçŠ¶æ€ä¸­åŒ…å«ç›¸ä¼¼ä»£ç ï¼Œä½ å¯ä»¥æä¾›ä¸€ä¸ªå°è£…æœ‰éƒ¨åˆ†é€šç”¨è¡Œä¸ºçš„ **ä¸­é—´æŠ½è±¡ç±»**ã€‚**çŠ¶æ€å¯¹è±¡å¯å­˜å‚¨å¯¹äºä¸Šä¸‹æ–‡çš„åå‘å¼•ç”¨**ã€‚çŠ¶æ€å¯ä»¥é€šè¿‡è¯¥å¼•ç”¨ä»ä¸Šä¸‹æ–‡è·å–æ‰€éœ€ä¿¡æ¯ï¼Œå¹¶ä¸”èƒ½è§¦å‘çŠ¶æ€è½¬ç§»ã€‚
4. ä¸Šä¸‹æ–‡å’Œå…·ä½“çŠ¶æ€éƒ½å¯ä»¥è®¾ç½®ä¸Šä¸‹æ–‡çš„ä¸‹ä¸ªçŠ¶æ€ï¼Œå¹¶å¯é€šè¿‡æ›¿æ¢è¿æ¥åˆ°ä¸Šä¸‹æ–‡çš„çŠ¶æ€å¯¹è±¡æ¥å®Œæˆå®é™…çš„çŠ¶æ€è½¬æ¢ã€‚

## 6. ğŸš€æ¡ˆä¾‹ä¸€

![|590](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358371.png)  
åœ¨æœ¬ä¾‹ä¸­ï¼ŒçŠ¶æ€æ¨¡å¼å…è®¸åª’ä½“æ’­æ”¾å™¨æ ¹æ®å½“å‰çš„å›æ”¾çŠ¶æ€è¿›è¡Œä¸åŒçš„æ§åˆ¶è¡Œä¸ºã€‚æ’­æ”¾å™¨ä¸»ç±»åŒ…å«ä¸€ä¸ªæŒ‡å‘çŠ¶æ€å¯¹è±¡çš„å¼•ç”¨ï¼Œå®ƒå°†å®Œæˆæ’­æ”¾å™¨çš„ç»å¤§éƒ¨åˆ†å·¥ä½œã€‚æŸäº›è¡Œä¸ºå¯èƒ½ä¼šç”¨ä¸€ä¸ªçŠ¶æ€å¯¹è±¡æ›¿æ¢å¦ä¸€ä¸ªçŠ¶æ€å¯¹è±¡ï¼Œæ”¹å˜æ’­æ”¾å™¨å¯¹ç”¨æˆ·äº¤äº’çš„å›åº”æ–¹å¼ã€‚

```java
public class Player {  
    private final List<String> playList = new ArrayList<>();  
    private int currentTrack = 0;  
    private State state;  
    private boolean playing = false;  
  
    public Player() {  
        this.state = new ReadyState(this);  
        setPlaying(true);  
        for (int i = 1; i <= 12; i++) {  
            playList.add("Track " + i);  
        }  
    }  
  
    public String startPlayback() {  
        return "Playing " + playList.get(this.currentTrack);  
    }  
  
    public String nextTrack() {  
        this.currentTrack++;  
        if (this.currentTrack > playList.size() - 1) {  
            this.currentTrack = 0;  
        }  
        return "Playing " + playList.get(this.currentTrack);  
    }  
  
    public String prevTrack() {  
        this.currentTrack--;  
        if (this.currentTrack < 0) {  
            this.currentTrack = playList.size() - 1;  
        }  
        return "Playing " + playList.get(this.currentTrack);  
    }  
  
    public void setCurrentTrackAfterStop() {  
        this.currentTrack = 0;  
    }  
  
    public State getState() {  
        return state;  
    }  
  
    public void setState(State state) {  
        this.state = state;  
    }  
  
    public boolean isPlaying() {  
        return playing;  
    }  
  
    public void setPlaying(boolean playing) {  
        this.playing = playing;  
    }  
}
```

```java
public abstract class State {  
    protected final Player player;  
  
    public State(Player player) {  
        this.player = player;  
    }  
  
    public abstract String play();  
  
    public abstract String stop();  
  
    public abstract String next();  
  
    public abstract String prev();  
}
```

```java
public class LockedState extends State {  
    public LockedState(Player player) {  
        super(player);  
    }  
  
    @Override  
    public String play() {  
        player.setState(new ReadyState(player));  
        return "Ready";  
    }  
  
    @Override  
    public String stop() {  
        if (player.isPlaying()) {  
            player.setState(new ReadyState(player));  
            return "Stop playing...";  
        }  
        return "Locked...";  
    }  
  
    @Override  
    public String next() {  
        return "Locked...";  
    }  
  
    @Override  
    public String prev() {  
        return "Locked...";  
    }  
}
```

```java
public class ReadyState extends State {  
    public ReadyState(Player player) {  
        super(player);  
    }  
  
    @Override  
    public String play() {  
        String action = player.startPlayback();  
        player.setState(new PlayingState(player));  
        return action;  
    }  
  
    @Override  
    public String stop() {  
        player.setState(new LockedState(player));  
        return "Locked...";  
    }  
  
    @Override  
    public String next() {  
        return "Locked...";  
    }  
  
    @Override  
    public String prev() {  
        return "Locked...";  
    }  
}
```

```java
public class PlayingState extends State {  
    public PlayingState(Player player) {  
        super(player);  
    }  
  
    @Override  
    public String play() {  
        player.setState(new ReadyState(player));  
        return "Paused...";  
    }  
  
    @Override  
    public String stop() {  
        player.setState(new LockedState(player));  
        player.setCurrentTrackAfterStop();  
        return "Stop Playing...";  
    }  
  
    @Override  
    public String next() {  
        return player.nextTrack();  
    }  
  
    @Override  
    public String prev() {  
        return player.prevTrack();  
    }  
}
```

```java
public class UI {  
    private static final JTextField textField = new JTextField();  
    private final Player player;  
  
    public UI(Player player) {  
        this.player = player;  
    }  
  
    public void init() {  
        JFrame frame = new JFrame("ç½‘æ˜“äº‘éŸ³ä¹");  
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);  
        JPanel context = new JPanel();  
        context.setLayout(new BoxLayout(context, BoxLayout.Y_AXIS));  
        frame.getContentPane().add(context);  
        JPanel buttons = new JPanel(new FlowLayout(FlowLayout.CENTER));  
        context.add(textField);  
        context.add(buttons);  
  
        // Context delegates handling user's input to a state object. Naturally,  
        // the outcome will depend on what state is currently active, since all        
        // states can handle the input differently.        
        JButton play = new JButton("Play");  
        play.addActionListener(e -> textField.setText(player.getState().play()));  
        JButton stop = new JButton("Stop");  
        stop.addActionListener(e -> textField.setText(player.getState().stop()));  
        JButton next = new JButton("Next");  
        next.addActionListener(e -> textField.setText(player.getState().next()));  
        JButton prev = new JButton("Prev");  
        prev.addActionListener(e -> textField.setText(player.getState().prev()));  
        frame.setVisible(true);  
        frame.setSize(300, 100);  
        buttons.add(play);  
        buttons.add(stop);  
        buttons.add(next);  
        buttons.add(prev);  
    }  
}
```

```java
public class PlayerTest {  
    public static void main(String[] args) {  
        UI ui = new UI(new Player());  
        ui.init();  
    }  
}
```

## 7. ğŸš€æ¡ˆä¾‹äºŒï¼šä½¿ç”¨ Spring çŠ¶æ€æœºå®ç°è®¢å•çŠ¶æ€æµç¨‹

> Spring çŠ¶æ€æœºå®˜æ–¹æ–‡æ¡£åœ°å€ï¼š[Spring Statemachine - Reference Documentation](https://docs.spring.io/spring-statemachine/docs/current/reference/)  
> å‚è€ƒæ–‡æ¡£ï¼š[Spring StateMachine - ä»£ç å¤©åœ°](https://www.codetd.com/article/1010726) [Spring StateMachineåŸºç¡€ç‰ˆ-å­¦ä¹ ç¬”è®° - x-zeros - åšå®¢å›­](https://www.cnblogs.com/Zero-Jo/p/13891075.html)

### 7.1. çŠ¶æ€æœº

æœ‰é™çŠ¶æ€æœºæ˜¯ä¸€ç§ç”¨æ¥è¿›è¡Œå¯¹è±¡è¡Œä¸ºå»ºæ¨¡çš„å·¥å…·ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯æè¿°å¯¹è±¡åœ¨å®ƒçš„å£°æ˜å‘¨æœŸæ‰€ç»å†çš„çŠ¶æ€åºåˆ—ï¼Œä»¥åŠå¦‚ä½•å“åº”æ¥è‡ªå¤–ç•Œçš„å„ç§äº‹ä»¶ã€‚  
åœ¨ç”µå•†åœºæ™¯ï¼ˆè®¢å•ã€ç‰©æµã€å”®åï¼‰ã€ç¤¾äº¤ï¼ˆIM æ¶ˆæ¯æŠ•é€’ï¼‰ã€åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†ï¼ˆåˆ†å¸ƒå¼è®¡ç®—å¹³å°ä»»åŠ¡ç¼–æ’ï¼‰ç­‰åœºæ™¯éƒ½æœ‰å¤§è§„æ¨¡çš„ä½¿ç”¨ã€‚

#### 7.1.1. çŠ¶æ€æœºçš„è¦ç´ 

çŠ¶æ€æœºå¯å½’çº³ä¸º 4 ä¸ªè¦ç´ ï¼š**ç°æ€ã€æ¡ä»¶ã€åŠ¨ä½œã€æ¬¡æ€**ã€‚â€œç°æ€â€å’Œâ€œæ¡ä»¶â€æ˜¯å› ï¼Œâ€œåŠ¨ä½œâ€å’Œâ€œæ¬¡æ€â€æ˜¯æœã€‚

- ç°æ€ï¼šæŒ‡å½“å‰æ‰€å¤„çš„çŠ¶æ€
- æ¡ä»¶ï¼šåˆç§°â€œäº‹ä»¶â€ï¼Œå½“ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³åï¼Œå°†ä¼šè§¦å‘ä¸€ä¸ªåŠ¨ä½œï¼Œæˆ–è€…æ‰§è¡Œä¸€æ¬¡çŠ¶æ€çš„è¿ç§»
- åŠ¨ä½œï¼šæ¡ä»¶æ»¡è¶³åæ‰§è¡Œçš„åŠ¨ä½œã€‚åŠ¨ä½œæ‰§è¡Œå®Œæ¯•åï¼Œå¯ä»¥è¿ç§»åˆ°æ–°çš„çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥ä»æ—§ä¿æŒåŸçŠ¶æ€ã€‚åŠ¨ä½œä¸æ˜¯å¿…é¡»çš„ï¼Œå½“æ¡ä»¶æ»¡è¶³åï¼Œä¹Ÿå¯ä»¥ä¸æ‰§è¡Œä»»ä½•åŠ¨ä½œï¼Œç›´æ¥è¿ç§»åˆ°æ–°çš„çŠ¶æ€ã€‚
- æ¬¡æ€ï¼šæ¡ä»¶æ»¡è¶³åè¦è¿ç§»çš„æ–°çŠ¶æ€ã€‚â€œæ¬¡æ€â€æ˜¯ç›¸å¯¹äºâ€œç°æ€â€è€Œè¨€çš„ï¼Œâ€œæ¬¡æ€â€ä¸€æ—¦è¢«æ¿€æ´»ï¼Œå°±è½¬æ¢æˆâ€œç°æ€â€ã€‚

#### 7.1.2. çŠ¶æ€æœºåŠ¨ä½œç±»å‹

- è¿›å…¥åŠ¨ä½œï¼šåœ¨è¿›å…¥çŠ¶æ€æ—¶è¿›è¡Œ
- é€€å‡ºåŠ¨ä½œï¼šåœ¨é€€å‡ºçŠ¶æ€æ—¶è¿›è¡Œ
- è¾“å…¥åŠ¨ä½œï¼šä¾èµ–äºå½“å‰çŠ¶æ€å’Œè¾“å…¥æ¡ä»¶è¿›è¡Œ
- è½¬ç§»åŠ¨ä½œï¼šåœ¨è¿›è¡Œç‰¹å®šè½¬ç§»æ—¶è¿›è¡Œ

### 7.2. Spring Statemachine

> ä»¥ä¸‹åªè´´å‡ºéƒ¨åˆ†ä»£ç ï¼Œæœ¬æ¡ˆä¾‹çš„å®Œæ•´ä»£ç åœ¨ [GitHub - xihuanxiaorang/design-pattern-study: é‡å­¦Javaè®¾è®¡æ¨¡å¼](https://github.com/xihuanxiaorang/design-pattern-study) ä»“åº“ä¸­çš„ `state-01` æ¨¡å—ï¼Œæœ‰éœ€è¦çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚ 

#### 7.2.1. å¼•å…¥ä¾èµ–

```xml
<dependency>  
    <groupId>org.springframework.boot</groupId>  
    <artifactId>spring-boot-starter</artifactId>  
</dependency>  
<dependency>  
    <groupId>org.springframework.statemachine</groupId>  
    <artifactId>spring-statemachine-starter</artifactId>  
    <version>3.2.0</version>  
</dependency>  
<dependency>  
    <groupId>org.projectlombok</groupId>  
    <artifactId>lombok</artifactId>  
</dependency>  
<dependency>  
    <groupId>org.springframework.boot</groupId>  
    <artifactId>spring-boot-starter-test</artifactId>  
    <scope>test</scope>  
</dependency>
```

#### 7.2.2. æ·»åŠ é…ç½®

```java
@Configuration  
@EnableStateMachine(name = "orderStateMachine")  
public class OrderStateMachineConfig extends StateMachineConfigurerAdapter<OrderStatus, OrderEvent> {  
    /**  
     * é…ç½®çŠ¶æ€  
     *  
     * @param states  
     * @throws Exception  
     */    @Override  
    public void configure(StateMachineStateConfigurer<OrderStatus, OrderEvent> states) throws Exception {  
        states  
                .withStates()  
                .initial(OrderStatus.WAIT_PAYMENT)  
                .states(EnumSet.allOf(OrderStatus.class));  
    }  
  
    /**  
     * é…ç½®çŠ¶æ€è½¬æ¢äº‹ä»¶å…³ç³»  
     *  
     * @param transitions  
     * @throws Exception  
     */    @Override  
    public void configure(StateMachineTransitionConfigurer<OrderStatus, OrderEvent> transitions) throws Exception {  
        transitions  
                .withExternal().source(OrderStatus.WAIT_PAYMENT).target(OrderStatus.WAIT_DELIVER).event(OrderEvent.PAYED)  
                .and()  
                .withExternal().source(OrderStatus.WAIT_DELIVER).target(OrderStatus.WAIT_RECEIVE).event(OrderEvent.DELIVERY)  
                .and()  
                .withExternal().source(OrderStatus.WAIT_RECEIVE).target(OrderStatus.FINISH).event(OrderEvent.RECEIVED);  
    }  
  
    /**  
     * æŒä¹…åŒ–é…ç½®  
     * å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥é…åˆredisç­‰ï¼Œè¿›è¡ŒæŒä¹…åŒ–æ“ä½œ  
     *  
     * @return  
     */  
    @Bean  
    public StateMachinePersister<OrderStatus, OrderEvent, Order> stateMachinePersister() {  
        return new DefaultStateMachinePersister<>(new StateMachinePersist<OrderStatus, OrderEvent, Order>() {  
            @Override  
            public void write(StateMachineContext<OrderStatus, OrderEvent> context, Order order) throws Exception {  
                //æ­¤å¤„å¹¶æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ  
            }  
  
            @Override  
            public StateMachineContext<OrderStatus, OrderEvent> read(Order order) throws Exception {  
                //æ­¤å¤„ç›´æ¥è·å–orderä¸­çš„çŠ¶æ€ï¼Œå…¶å®å¹¶æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–è¯»å–æ“ä½œ  
                return new DefaultStateMachineContext<>(order.getStatus(), null, null, null);  
            }  
        });  
    }  
}
```

#### 7.2.3. æ·»åŠ è®¢å•çŠ¶æ€ç›‘å¬å™¨

```java
@Component  
@WithStateMachine(name = "orderStateMachine")  
public class OrderStateListener {  
    private static final Logger LOGGER = LoggerFactory.getLogger(OrderStateListener.class);  
  
    @OnTransition(source = "WAIT_PAYMENT", target = "WAIT_DELIVER")  
    public boolean payTransition(Message<OrderEvent> message) {  
        Order order = (Order) message.getHeaders().get("order");  
        assert order != null;  
        order.setStatus(OrderStatus.WAIT_DELIVER);  
        LOGGER.debug("æ”¯ä»˜ {}", order);  
        return true;    }  
  
    @OnTransition(source = "WAIT_DELIVER", target = "WAIT_RECEIVE")  
    public boolean deliverTransition(Message<OrderEvent> message) {  
        Order order = (Order) message.getHeaders().get("order");  
        assert order != null;  
        order.setStatus(OrderStatus.WAIT_RECEIVE);  
        LOGGER.debug("å‘è´§ {}", order);  
        return true;    }  
  
    @OnTransition(source = "WAIT_RECEIVE", target = "FINISH")  
    public boolean receiveTransition(Message<OrderEvent> message) {  
        Order order = (Order) message.getHeaders().get("order");  
        assert order != null;  
        order.setStatus(OrderStatus.FINISH);  
        LOGGER.debug("æ”¶è´§ {}", order);  
        return true;    }  
}
```

#### 7.2.4. åœ¨è®¢å•æœåŠ¡ä¸­ä½¿ç”¨

```java
@Service  
public class OrderServiceImpl implements OrderService {  
    private static final Logger LOGGER = LoggerFactory.getLogger(OrderServiceImpl.class);  
    private final StateMachine<OrderStatus, OrderEvent> orderStateMachine;  
    private final StateMachinePersister<OrderStatus, OrderEvent, Order> orderStateMachinePersister;  
    private final OrderRepository orderRepository;  
    private Integer orderId = 1;  
  
    public OrderServiceImpl(StateMachine<OrderStatus, OrderEvent> orderStateMachine, StateMachinePersister<OrderStatus, OrderEvent, Order> orderStateMachinePersister, OrderRepository orderRepository) {  
        this.orderStateMachine = orderStateMachine;  
        this.orderStateMachinePersister = orderStateMachinePersister;  
        this.orderRepository = orderRepository;  
    }  
  
    @Override  
    public Order creat() {  
        Integer orderId = generateOrderId();  
        Order order = Order.builder().id(orderId).status(OrderStatus.WAIT_PAYMENT).build();  
        return orderRepository.save(orderId, order);  
    }  
  
    @Override  
    public Order pay(Integer id) {  
        Order order = orderRepository.get(id);  
        if (order != null) {  
            LOGGER.debug("å°è¯•æ”¯ä»˜è®¢å•{}", order);  
            Message<OrderEvent> message = MessageBuilder.withPayload(OrderEvent.PAYED).setHeader("order", order).build();  
            if (!sendEvent(message, order)) {  
                LOGGER.debug("è®¢å•{}æ”¯ä»˜å¤±è´¥ï¼ŒçŠ¶æ€å¼‚å¸¸ï¼", order);  
            }  
        }  
        return order;  
    }  
  
    @Override  
    public Order deliver(Integer id) {  
        Order order = orderRepository.get(id);  
        if (order != null) {  
            LOGGER.debug("å°è¯•å‘è´§{}", order);  
            Message<OrderEvent> message = MessageBuilder.withPayload(OrderEvent.DELIVERY).setHeader("order", order).build();  
            if (!sendEvent(message, order)) {  
                LOGGER.debug("å°è¯•å‘è´§{}å¤±è´¥ï¼ŒçŠ¶æ€å¼‚å¸¸ï¼", order);  
            }  
        }  
        return order;  
    }  
  
    @Override  
    public Order receive(Integer id) {  
        Order order = orderRepository.get(id);  
        if (order != null) {  
            LOGGER.debug("å°è¯•æ”¶è´§{}", order);  
            Message<OrderEvent> message = MessageBuilder.withPayload(OrderEvent.RECEIVED).setHeader("order", order).build();  
            if (!sendEvent(message, order)) {  
                LOGGER.debug("å°è¯•æ”¶è´§{}å¤±è´¥ï¼ŒçŠ¶æ€å¼‚å¸¸ï¼", order);  
            }  
        }  
        return order;  
    }  
  
    @Override  
    public List<Order> getAllOrders() {  
        return orderRepository.findAll();  
    }  
  
    private synchronized boolean sendEvent(Message<OrderEvent> message, Order order) {  
        boolean result = false;  
        try {  
            orderStateMachine.start();  
            orderStateMachinePersister.restore(orderStateMachine, order);  
            TimeUnit.SECONDS.sleep(1);  
            result = orderStateMachine.sendEvent(message);  
            orderStateMachinePersister.persist(orderStateMachine, order);  
        } catch (Exception e) {  
            e.printStackTrace();  
        } finally {  
            orderStateMachine.stop();  
        }  
        return result;  
    }  
  
    private Integer generateOrderId() {  
        return orderId++;  
    }  
}
```

#### 7.2.5. æµ‹è¯•ç±»

```java
@SpringBootTest  
class State01ApplicationTests {  
    private static final Logger LOGGER = LoggerFactory.getLogger(State01ApplicationTests.class);  
    @Autowired  
    private OrderService orderService;  
  
    @Test  
    void contextLoads() throws InterruptedException {  
        orderService.creat();  
        orderService.creat();  
  
        orderService.pay(1);  
  
        Thread t1 = new Thread(() -> {  
            orderService.deliver(1);  
            orderService.receive(1);  
        }, "t1");  
        t1.start();  
  
        orderService.pay(2);  
        orderService.deliver(2);  
        orderService.receive(2);  
        t1.join();  
        LOGGER.debug("{}", orderService.getAllOrders());  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š  
![](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211132358679.png)

## 8. ğŸš€æ¡ˆä¾‹ä¸‰ï¼šæå®¢å°å·¥å…·

> Qï¼šé™¤äº†åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨çŠ¶æ€æ¨¡å¼è§£å†³ä¸šåŠ¡éœ€æ±‚ä¹‹å¤–ï¼Œæœ‰æ²¡æœ‰å…¶ä»–ä»¥ä¸€ç§æœ‰è¶£çš„æ–¹å¼æ¥ä½¿ç”¨çŠ¶æ€æ¨¡å¼å‘¢ï¼Ÿ  
> Aï¼šæœ‰çš„ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹è¿™ä¸€ç¯‡æ–‡ç«  [æå®¢å°å·¥å…·](../æ‚è®°/æå®¢å°å·¥å…·/README.md)ï¼Œåœ¨è¯¥ç¯‡æ–‡ç« ä¸­è¯¦ç»†åœ°ä»‹ç»äº†çŠ¶æ€æ¨¡å¼ä¸ Spring Shell æ˜¯æ€æ ·ç»“åˆä½¿ç”¨æ¥è®¾è®¡å‡ºä¸€ä¸ªå®ç”¨çš„å°å·¥å…·ã€‚

## 9. ğŸ‰åº”ç”¨åœºæ™¯

ğŸ **å¦‚æœå¯¹è±¡éœ€è¦æ ¹æ®è‡ªèº«å½“å‰çŠ¶æ€è¿›è¡Œä¸åŒè¡Œä¸ºï¼ŒåŒæ—¶çŠ¶æ€çš„æ•°é‡éå¸¸å¤šä¸”ä¸çŠ¶æ€ç›¸å…³çš„ä»£ç ä¼šé¢‘ç¹å˜æ›´çš„è¯ï¼Œå¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼**ã€‚  
âš¡æ¨¡å¼å»ºè®®ä½ å°†æ‰€æœ‰ç‰¹å®šäºçŠ¶æ€çš„ä»£ç æŠ½å–åˆ°ä¸€ç»„ç‹¬ç«‹çš„ç±»ä¸­ã€‚è¿™æ ·ä¾èµ–ï¼Œä½ å¯ä»¥åœ¨ç‹¬ç«‹äºå…¶ä»–çŠ¶æ€çš„æƒ…å†µä¸‹æ·»åŠ æ–°çŠ¶æ€æˆ–ä¿®æ”¹å·²æœ‰çŠ¶æ€ï¼Œä»è€Œå‡å°‘ç»´æŠ¤æˆæœ¬ã€‚

---

ğŸ **å¦‚æœæŸä¸ªç±»éœ€è¦æ ¹æ®æˆå‘˜å˜é‡çš„å½“å‰å€¼æ”¹å˜è‡ªèº«è¡Œä¸ºï¼Œä»è€Œéœ€è¦ä½¿ç”¨å¤§é‡çš„æ¡ä»¶è¯­å¥æ—¶ï¼Œå¯ä½¿ç”¨è¯¥æ¨¡å¼**ã€‚  
âš¡çŠ¶æ€æ¨¡å¼ä¼šå°†è¿™äº›æ¡ä»¶è¯­å¥çš„åˆ†æ”¯æŠ½å–åˆ°ç›¸åº”çŠ¶æ€ç±»çš„æ–¹æ³•ä¸­ã€‚åŒæ—¶ï¼Œä½ è¿˜å¯ä»¥æ¸…é™¤ä¸»è¦ç±»ä¸­ä¸ç‰¹å®šçŠ¶æ€çš„ç›¸å…³çš„ä¸´æ—¶å˜é‡å’Œå¸®æ‰‹æ–¹æ³•ä»£ç ã€‚

---

ğŸ **å½“ç›¸ä¼¼çŠ¶æ€å’ŒåŸºäºæ¡ä»¶çš„çŠ¶æ€æœºè½¬æ¢ä¸­å­˜åœ¨è®¸å¤šé‡å¤ä»£ç æ—¶ï¼Œå¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼**ã€‚  
âš¡çŠ¶æ€æ¨¡å¼è®©ä½ èƒ½å¤Ÿç”ŸæˆçŠ¶æ€ç±»å±‚æ¬¡ç»“æ„ï¼Œé€šè¿‡å°†å…¬ç”¨ä»£ç æŠ½å–åˆ°æŠ½è±¡åŸºç±»ä¸­æ¥å‡å°‘é‡å¤ã€‚

## 10. ğŸ“å®ç°æ–¹å¼

1. ç¡®å®šå“ªäº›ç±»æ˜¯ä¸Šä¸‹æ–‡ã€‚å®ƒå¯èƒ½æ˜¯åŒ…å«ä¾èµ–äºçŠ¶æ€çš„ä»£ç çš„å·²æœ‰ç±»ï¼›å¦‚æœç‰¹å®šäºçŠ¶æ€çš„ä»£ç åˆ†æ•£åœ¨å¤šä¸ªç±»ä¸­ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæ–°çš„ç±»ã€‚
2. å£°æ˜çŠ¶æ€æ¥å£ã€‚è™½ç„¶ä½ å¯èƒ½ä¼šéœ€è¦å®Œå…¨å¤åˆ¶ä¸Šä¸‹æ–‡ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼Œä½†æœ€å¥½æ˜¯ä»…æŠŠå…³æ³¨ç‚¹æ”¾åœ¨é‚£äº›å¯èƒ½åŒ…å«ç‰¹å®šäºçŠ¶æ€çš„è¡Œä¸ºçš„æ–¹æ³•ä¸Šã€‚
3. ä¸ºæ¯ä¸ªå®é™…çŠ¶æ€åˆ›å»ºä¸€ä¸ªç»§æ‰¿äºçŠ¶æ€æ¥å£çš„ç±»ã€‚ç„¶åæ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­çš„æ–¹æ³•å¹¶å°†ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„æ‰€æœ‰ä»£ç æŠ½å–åˆ°æ–°å»ºçš„ç±»ä¸­ã€‚åœ¨å°†ä»£ç ç§»åŠ¨åˆ°çŠ¶æ€ç±»çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½ä¼šå‘ç°å®ƒä¾èµ–äºä¸Šä¸‹æ–‡ä¸­çš„ä¸€äº›ç§æœ‰æˆå‘˜ã€‚ä½ å¯ä»¥é‡‡ç”¨ä»¥ä¸‹å‡ ç§å˜é€šæ–¹å¼ï¼š
	- å°†è¿™äº›æˆå‘˜å˜é‡æˆ–æ–¹æ³•è®¾ä¸ºå…±æœ‰ã€‚
	- å°†éœ€è¦æŠ½å–çš„ä¸Šä¸‹æ–‡è¡Œä¸ºæ›´æ”¹ä¸ºä¸Šä¸‹æ–‡ä¸­çš„å…±æœ‰æ–¹æ³•ï¼Œç„¶ååœ¨çŠ¶æ€ç±»ä¸­è°ƒç”¨ã€‚è¿™ç§æ–¹å¼ç®€é™‹å´ä¾¿æ·ï¼Œä½ å¯ä»¥ç¨åå†å¯¹å…¶è¿›è¡Œä¿®è¡¥ã€‚
	- å°†çŠ¶æ€ç±»åµŒå¥—åœ¨ä¸Šä¸‹æ–‡ç±»ä¸­ã€‚è¿™ç§æ–¹å¼éœ€è¦ä½ æ‰€æœ‰çš„ç¼–ç¨‹è¯­è¨€æ”¯æŒåµŒå¥—ç±»ã€‚
4. åœ¨ä¸Šä¸‹æ–‡ç±»ä¸­æ·»åŠ ä¸€ä¸ªçŠ¶æ€æ¥å£ç±»å‹çš„å¼•ç”¨æˆå‘˜å˜é‡ï¼Œä»¥åŠä¸€ä¸ªç”¨äºä¿®æ”¹è¯¥æˆå‘˜å˜é‡å€¼çš„å…¬æœ‰è®¾ç½®å™¨ã€‚
5. å†æ¬¡æ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­çš„æ–¹æ³•ï¼Œå°†ç©ºçš„æ¡ä»¶è¯­å¥æ›¿æ¢ä¸ºç›¸åº”çš„çŠ¶æ€å¯¹è±¡æ–¹æ³•ã€‚
6. ä¸ºåˆ‡æ¢ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œä½ éœ€è¦åˆ›å»ºæŸä¸ªçŠ¶æ€ç±»å®ä¾‹å¹¶å°†å…¶ä¼ é€’ç»™ä¸Šä¸‹æ–‡ã€‚ä½ å¯ä»¥åœ¨ä¸Šä¸‹æ–‡ã€å„ç§çŠ¶æ€æˆ–å®¢æˆ·ç«¯ä¸­å®Œæˆè¿™é¡¹å·¥ä½œã€‚æ— è®ºåœ¨ä½•å¤„å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè¯¥ç±»éƒ½å°†ä¾èµ–äºå…¶æ‰€å®ä¾‹åŒ–çš„å…·ä½“ç±»ã€‚

## 11. âš–ï¸ä¼˜ç¼ºç‚¹

- âœ”ï¸ **å•ä¸€èŒè´£åŸåˆ™**ã€‚å°†ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„ä»£ç æ”¾åœ¨å•ç‹¬çš„ç±»ä¸­ã€‚
- âœ”ï¸ **å¼€é—­åŸåˆ™**ã€‚æ— éœ€ä¿®æ”¹å·²æœ‰çŠ¶æ€ç±»å’Œä¸Šä¸‹æ–‡å°±èƒ½å¼•å…¥æ–°çŠ¶æ€ã€‚
- âœ”ï¸ é€šè¿‡æ¶ˆé™¤è‡ƒè‚¿çš„çŠ¶æ€æœºæ¡ä»¶è¯­å¥ç®€åŒ–ä¸Šä¸‹æ–‡ä»£ç ã€‚
- âŒ å¦‚æœçŠ¶æ€æœºåªæœ‰å¾ˆå°‘çš„å‡ ä¸ªçŠ¶æ€ï¼Œæˆ–è€…å¾ˆå°‘å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆåº”ç”¨è¯¥æ¨¡å¼å¯èƒ½ä¼šæ˜¾å¾—å°é¢˜å¤§åšã€‚
