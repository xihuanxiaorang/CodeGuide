---
title: å•ä¾‹æ¨¡å¼
tags:
  - è®¾è®¡æ¨¡å¼ 
created: 2022-07-22 18:29:06
modified: 2022-10-11 16:40:55
number headings: auto, first-level 1, max 6, _.1.1.
---

# å•ä¾‹æ¨¡å¼

## 1. ğŸ¨æ„å›¾

**å•ä¾‹æ¨¡å¼** æ˜¯æŒ‡ç¡®ä¿ **ä¸€ä¸ªç±»ä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹åªæœ‰ä¸€ä¸ªå®ä¾‹**ï¼Œå¹¶æä¾› **ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹**ã€‚  
![|500](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005633.png)

## 2. ğŸºæ¡ˆä¾‹åœºæ™¯

1. æ•°æ®åº“çš„è¿æ¥æ± 
2. ApplicationContext

## 3. ğŸ™é—®é¢˜

1. **ä¸€ä¸ªç±»ä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹åªæœ‰ä¸€ä¸ªå®ä¾‹**ã€‚å¦‚ ApplicationContextã€æ•°æ®åº“çš„è¿æ¥æ± ç­‰ç­‰ã€‚
2. **ä¸ºè¯¥å®ä¾‹æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®èŠ‚ç‚¹**ã€‚

## 4. ğŸ¥³è§£å†³æ–¹æ¡ˆ

### 4.1. 1ã€é¥¿æ±‰å¼

æ‰€æœ‰å•ä¾‹çš„å®ç°éƒ½åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªç›¸åŒçš„æ­¥éª¤ï¼š

- **å°†é»˜è®¤æ„é€ å‡½æ•°è®¾ä¸ºç§æœ‰**ï¼ŒÂ é˜²æ­¢å…¶ä»–å¯¹è±¡ä½¿ç”¨å•ä¾‹ç±»çš„Â `new` è¿ç®—ç¬¦ã€‚
- **æ–°å»ºä¸€ä¸ªé™æ€æ„å»ºæ–¹æ³•ä½œä¸ºæ„é€ å‡½æ•°**ã€‚Â è¯¥å‡½æ•°ä¼šÂ â€œå·å·â€Â è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°æ¥åˆ›å»ºå¯¹è±¡ï¼ŒÂ å¹¶å°†å…¶ä¿å­˜åœ¨ä¸€ä¸ªé™æ€æˆå‘˜å˜é‡ä¸­ã€‚Â æ­¤åæ‰€æœ‰å¯¹äºè¯¥å‡½æ•°çš„è°ƒç”¨éƒ½å°†è¿”å›è¿™ä¸€ç¼“å­˜å¯¹è±¡ã€‚  
**ç‰¹ç‚¹**ï¼šé¥¿æ±‰å¼å•ä¾‹æ¨¡å¼ **åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±ç«‹å³åˆå§‹åŒ–ï¼Œå¹¶ä¸”åˆ›å»ºå•ä¾‹å¯¹è±¡**ã€‚å®ƒç»å¯¹ **çº¿ç¨‹å®‰å…¨**ï¼Œåœ¨çº¿ç¨‹è¿˜æ²¡å‡ºç°ä»¥å‰å°±å®ä¾‹åŒ–äº†ï¼Œä¸å¯èƒ½å­˜åœ¨è®¿é—®å®‰å…¨é—®é¢˜ã€‚  
**ä¼˜ç¼ºç‚¹**ï¼š
- ä¼˜ç‚¹ï¼šæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œæ‰§è¡Œæ•ˆç‡æ¯”è¾ƒé«˜ï¼Œç”¨æˆ·ä½“éªŒæ¯”æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼æ›´å¥½ã€‚
- ç¼ºç‚¹ï¼šç±»åŠ è½½çš„æ—¶å€™å°±åˆå§‹åŒ–ï¼Œä¸ç®¡ç”¨ä¸ç”¨éƒ½å ç€ç©ºé—´ï¼Œæµªè´¹äº†å†…å­˜ã€‚

```java
public class HungrySingleton {  
    private static final HungrySingleton INSTANCE = new HungrySingleton();  
  
    private HungrySingleton() {  
    }  
    public static HungrySingleton getInstance() {  
        return INSTANCE;  
    }  
}
```

```java
public class HungrySingletonTest {  
    @Test  
    public void test() {  
        HungrySingleton hungrySingleton1 = HungrySingleton.getInstance();  
        HungrySingleton hungrySingleton2 = HungrySingleton.getInstance();  
        System.out.println(hungrySingleton1);  
        System.out.println(hungrySingleton2);  
    }  
}
```

### 4.2. 2ã€æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰

**ç‰¹ç‚¹**ï¼š**è¢«å¤–éƒ¨ç±»è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå»å®ä¾‹åŒ–**

```java
public class LazySimpleSingleton {  
    private static LazySimpleSingleton lazySimpleSingleton;  
  
    private LazySimpleSingleton() {  
    }  
    public static LazySimpleSingleton getInstance() {  
        if (lazySimpleSingleton == null) {  
            lazySimpleSingleton = new LazySimpleSingleton();  
        }  
        return lazySimpleSingleton;  
    }  
}
```

```java
public class LazySimpleSingletonTest {  
    @Test  
    public void test() {  
        Runnable runnable = () -> {  
            LazySimpleSingleton instance = LazySimpleSingleton.getInstance();  
            System.out.println(Thread.currentThread().getName() + ": " + instance);  
        };  
        Thread t1 = new Thread(runnable);  
        Thread t2 = new Thread(runnable);  
        t1.start();  
        t2.start();  
        System.out.println("å¼€å§‹æ‰§è¡Œ...");  
    }  
}
```

å¤šæ¬¡è¿è¡Œå‡ºç°ä¸åŒçš„ç»“æœï¼Œè¿™æ„å‘³ç€ä¸Šé¢çš„å•ä¾‹ **å­˜åœ¨çº¿ç¨‹å®‰å…¨éšæ‚£**ã€‚

- åŒä¸€ä¸ªå®ä¾‹ï¼š
	- æ­£å¸¸æ‰§è¡Œ
	- åè€…è¦†ç›–å‰è€…æƒ…å†µ
- ä¸åŒçš„å®ä¾‹ï¼š
	- åŒæ—¶è¿›å…¥æ¡ä»¶ï¼ŒæŒ‰é¡ºåºè¿”å›  
å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ¨¡å¼è°ƒè¯•ï¼Œæ‰‹åŠ¨æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºæ¥æ¨¡æ‹Ÿä¸Šè¿°ç»“æœå‡ºç°çš„è¿‡ç¨‹ã€‚

### 4.3. 3ã€åŒé‡æ£€æŸ¥é”

é‰´äº **æ‡’æ±‰å¼** çº¿ç¨‹ä¸å®‰å…¨ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•æ¥ä¼˜åŒ–ä»£ç ï¼Œä½¿å¾—æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼åœ¨çº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨å‘¢ï¼Ÿ**ç»™ `getInstance` æ–¹æ³•åŠ ä¸Š `synchronized` å…³é”®å­—**ï¼Œä½¿è¿™ä¸ªæ–¹æ³•å˜æˆçº¿ç¨‹åŒæ­¥æ–¹æ³•ï¼š

```java
public class LazySimpleSingleton {  
    private static LazySimpleSingleton lazySimpleSingleton;  
  
    private LazySimpleSingleton() {  
    }  
    public static synchronized LazySimpleSingleton getInstance() {  
        if (lazySimpleSingleton == null) {  
            lazySimpleSingleton = new LazySimpleSingleton();  
        }  
        return lazySimpleSingleton;  
    }  
}
```

å†æ¥è°ƒè¯•ã€‚å½“æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹å¹¶è°ƒç”¨ `getInstance` æ–¹æ³•æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†è°ƒç”¨ `getInstance` æ–¹æ³•ï¼Œçº¿ç¨‹çš„çŠ¶æ€ç”± `RUNNING` => `MONITOR`ï¼Œå‡ºç°é˜»å¡ã€‚ç›´åˆ°ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œï¼Œç¬¬äºŒä¸ªçº¿ç¨‹æ‰æ¢å¤åˆ° `RUNNING` çŠ¶æ€å¹¶è°ƒç”¨ `getInstance` æ–¹æ³•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  
![|500](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140006987.png)  
ä¸Šå›¾å®Œç¾åœ°å±•ç°äº† `synchronized` ç›‘è§†é”çš„è¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹çš„å®‰å…¨é—®é¢˜è§£å†³äº†ã€‚ä½†æ˜¯ï¼Œç”¨ `synchronized` åŠ é”æ—¶ï¼Œåœ¨çº¿ç¨‹æ•°é‡æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¦‚æœ CPU åˆ†é…å‹åŠ›ä¸Šå‡ï¼Œåˆ™ä¼šå¯¼è‡´å¤§æ‰¹çº¿ç¨‹é˜»å¡ï¼Œä»è€Œå¯¼è‡´ç¨‹åºæ€§èƒ½å¤§å¹…ä¸‹é™ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä¸€ç§æ›´å¥½çš„æ–¹å¼ï¼Œæ—¢èƒ½å…¼é¡¾çº¿ç¨‹å®‰å…¨åˆèƒ½æå‡ç¨‹åºæ€§èƒ½å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚æ¥çœ‹çœ‹ **åŒé‡æ£€æŸ¥é”çš„å•ä¾‹æ¨¡å¼**ï¼š

```java
public class LazyDoubleCheckSingleton {  
    private static volatile LazyDoubleCheckSingleton lazyDoubleCheckSingleton;  
  
    private LazyDoubleCheckSingleton() {  
    }  
    public static LazyDoubleCheckSingleton getInstance() {  
        if (lazyDoubleCheckSingleton == null) {  
            synchronized (LazyDoubleCheckSingleton.class) {  
                if (lazyDoubleCheckSingleton == null) {  
                    lazyDoubleCheckSingleton = new LazyDoubleCheckSingleton();  
                }  
            }  
        }  
        return lazyDoubleCheckSingleton;  
    }  
}
```

### 4.4. 4ã€é™æ€å†…éƒ¨ç±»

ç»†å¿ƒçš„å°ä¼™ä¼´å¯èƒ½ä¼šå‘ç°ï¼Œå½“æˆ‘ä»¬æŠŠé¼ æ ‡æ”¾åœ¨ **åŒé‡æ£€æŸ¥é”** çš„ç¬¬ä¸€ä¸ª if ä¸Šæ—¶ï¼Œä¼šå‡ºç°æç¤ºï¼Œç‚¹å‡»ä¹‹åä»£ç ä¼šè‡ªåŠ¨å˜æˆ **é™æ€å†…éƒ¨ç±»** çš„è¿™ç§æ–¹å¼ã€‚  
![|500](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005616.png)  
ä½¿ç”¨ **é™æ€å†…éƒ¨ç±»å®ç°å•ä¾‹æ¨¡å¼** è¿™ç§æ–¹å¼ï¼Œå…¼é¡¾äº† **é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼çš„å†…å­˜æµªè´¹** é—®é¢˜å’Œ **`synchronized` çš„æ€§èƒ½é—®é¢˜**ï¼Œå®Œç¾åœ°å±è”½äº†è¿™ä¸¤ä¸ªç¼ºç‚¹ã€‚  
å†…éƒ¨ç±»ä¸€å®šè¦æ˜¯åœ¨æ–¹æ³•è°ƒç”¨ä¹‹å‰åˆå§‹åŒ–ï¼Œå·§å¦™åœ°é¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

```java
public class LazyStaticInnerSingleton {  
    private LazyStaticInnerSingleton() {  
        
    }  
  
    // static å…³é”®å­—æ˜¯ä¸ºäº†ä½¿å•ä¾‹çš„ç©ºé—´å…±äº«ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«é‡å†™ã€é‡è½½  
    public static LazyStaticInnerSingleton getInstance() {  
        // åœ¨ç»“æœè¿”å›ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆåŠ è½½å†…éƒ¨ç±»  
        return LazyHolder.INSTANCE;  
    }  
  
    // é»˜è®¤ä¸åŠ è½½  
    private static class LazyHolder {  
        private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();  
    }  
}
```

### 4.5. 5ã€åå°„ç ´åå•ä¾‹

ä¸Šé¢ä»‹ç»çš„å•ä¾‹æ¨¡å¼çš„æ„é€ æ–¹æ³•é™¤äº†åŠ ä¸Š `private` å…³é”®å­—ï¼Œæ²¡æœ‰åšä»»ä½•å¤„ç†ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨åå°„æ¥è°ƒç”¨å…¶æ„é€ æ–¹æ³•ï¼Œå†è°ƒç”¨ `newInstance()` æ–¹æ³•ï¼Œåº”è¯¥ä¼šå‡ºç°ä¸¤ä¸ªä¸åŒçš„å®ä¾‹ã€‚

```java
@Test  
public void test1() {  
    // æµ‹è¯•åå°„ç ´åå•ä¾‹  
    Class<LazyStaticInnerSingleton> clazz = LazyStaticInnerSingleton.class;  
    try {  
        // é€šè¿‡åå°„çš„æ–¹å¼è·å–ç§æœ‰çš„æ„é€ æ–¹æ³•  
        Constructor<LazyStaticInnerSingleton> constructor = clazz.getDeclaredConstructor();  
        // å¼ºåˆ¶è®¿é—®  
        constructor.setAccessible(true);  
        // æš´åŠ›åˆå§‹åŒ–  
        LazyStaticInnerSingleton o1 = constructor.newInstance();   
        System.out.println(o1);  
    } catch (Exception e) {  
        throw new RuntimeException(e);  
    }  
}
```

æµ‹è¯•ç»“æœä¸º falseã€‚æ˜¾ç„¶ï¼Œåˆ›å»ºäº†ä¸¤ä¸ªä¸åŒçš„å®ä¾‹ã€‚ç°åœ¨ï¼Œåœ¨å…¶æ„é€ æ–¹æ³•ä¸­åšä¸€äº›é™åˆ¶ï¼Œä¸€æ—¦ä½¿ç”¨åå°„è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå®ä¾‹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ä¼˜åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š

```java
public class LazyStaticInnerSingleton {  
    private LazyStaticInnerSingleton() {  
		if (LazyHolder.INSTANCE != null) {  
			throw new RuntimeException("æ— æ•ˆè®¿é—®ï¼Œæ— æƒè®¿é—®æ„é€ æ–¹æ³•");  
		}  
    }  
  
    // static å…³é”®å­—æ˜¯ä¸ºäº†ä½¿å•ä¾‹çš„ç©ºé—´å…±äº«ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«é‡å†™ã€é‡è½½  
    public static LazyStaticInnerSingleton getInstance() {  
        // åœ¨ç»“æœè¿”å›ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆåŠ è½½å†…éƒ¨ç±»  
        return LazyHolder.INSTANCE;  
    }  
  
    // é»˜è®¤ä¸åŠ è½½  
    private static class LazyHolder {  
        private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();  
    }  
}
```

å†æ¬¡è¿è¡Œæµ‹è¯•ä»£ç ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚  
![1000](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005556.png)  

### 4.6. 6ã€åºåˆ—åŒ–ç ´åå•ä¾‹

ä¸€ä¸ªå•ä¾‹å¯¹è±¡åˆ›å»ºå¥½åï¼Œæœ‰æ—¶å€™éœ€è¦å°†å¯¹è±¡åºåˆ—åŒ–ç„¶åå†™å…¥ç£ç›˜ï¼Œä¸‹æ¬¡ä½¿ç”¨æ—¶å†ä»ç£ç›˜ä¸­è¯»å–å¯¹è±¡å¹¶è¿›è¡Œååºåˆ—åŒ–ï¼Œå°†å…¶è½¬åŒ–ä¸ºå†…å­˜å¯¹è±¡ã€‚ååºåˆ—åŒ–åçš„å¯¹è±¡ä¼šé‡æ–°åˆ†é…å†…å­˜ï¼Œå³é‡æ–°åˆ›å»ºã€‚å¦‚æœåºåˆ—åŒ–çš„ç›®æ ‡å¯¹è±¡ä¸ºå•ä¾‹å¯¹è±¡ï¼Œå°±è¿èƒŒäº†å•ä¾‹æ¨¡å¼çš„åˆè¡·ï¼Œç›¸å½“äºç ´åäº†å•ä¾‹ã€‚  

1. **åºåˆ—åŒ–** å°±æ˜¯æŠŠå†…å­˜ä¸­çš„çŠ¶æ€é€šè¿‡è½¬æ¢æˆå­—èŠ‚ç çš„å½¢å¼ï¼Œä»è€Œè½¬æ¢æˆä¸€ä¸ª I/O æµï¼Œå†™å…¥å…¶ä»–åœ°æ–¹ï¼ˆå¯ä»¥æ˜¯ç£ç›˜ã€ç½‘ç»œ I/Oï¼‰ï¼Œ**å†…å­˜ä¸­çš„çŠ¶æ€ä¼šæ°¸ä¹…ä¿å­˜ä¸‹æ¥**ã€‚
2. **ååºåˆ—åŒ–** å°±æ˜¯å°†å·²ç»æŒä¹…åŒ–çš„å­—èŠ‚ç å†…å®¹è½¬æ¢ä¸º I/O æµï¼Œé€šè¿‡è¯»å– I/O æµï¼Œè¿›è€Œå°†è¯»å–çš„å†…å®¹è½¬æ¢ä¸º Java å¯¹è±¡ï¼Œåœ¨è½¬æ¢çš„è¿‡ç¨‹ä¸­ä¼š **é‡æ–°åˆ›å»ºå¯¹è±¡** newã€‚  
é¦–å…ˆè®©é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼çš„ `LazyStaticInnerSingleton` ç±»å®ç°åºåˆ—åŒ– `Serializable` æ¥å£ã€‚ç„¶åç¼–å†™æµ‹è¯•ä»£ç ï¼š

```java
@Test  
public void test2() {  
    LazyStaticInnerSingleton s1 = null;  
    LazyStaticInnerSingleton s2 = LazyStaticInnerSingleton.getInstance();  
    FileOutputStream fos = null;  
    try {  
        fos = new FileOutputStream("LazyStaticInnerSingleton.obj");  
        ObjectOutputStream oos = new ObjectOutputStream(fos);  
        oos.writeObject(s2);  
        oos.flush();  
        oos.close();  
  
        FileInputStream fis = new FileInputStream("LazyStaticInnerSingleton.obj");  
        ObjectInputStream ois = new ObjectInputStream(fis);  
        s1 = (LazyStaticInnerSingleton) ois.readObject();  
        ois.close();  
  
        System.out.println(s1);  
        System.out.println(s2);  
        System.out.println(s1 == s2);  
    } catch (Exception e) {  
        throw new RuntimeException(e);  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š  
![|600](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005643.png)  
ä»è¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œ**ååºåˆ—åŒ–åçš„å¯¹è±¡å’Œæ‰‹åŠ¨åˆ›å»ºçš„å¯¹è±¡æ˜¯ä¸ä¸€è‡´çš„**ï¼Œå®ä¾‹åŒ–äº†ä¸¤æ¬¡ï¼Œè¿èƒŒäº†å•ä¾‹æ¨¡å¼çš„è®¾è®¡åˆè¡·ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•ä¿è¯åœ¨åºåˆ—åŒ–åçš„æƒ…å†µä¸‹ä¹Ÿèƒ½å¤Ÿå®ç°å•ä¾‹æ¨¡å¼å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåªéœ€è¦ **å¢åŠ  `readResolve()` æ–¹æ³•** å³å¯ã€‚å¦‚ä¸‹ï¼š

```java
public class LazyStaticInnerSingleton implements Serializable {  
    private LazyStaticInnerSingleton() {  
        if (LazyHolder.INSTANCE != null) {  
            throw new RuntimeException("æ— æ•ˆè®¿é—®ï¼Œæ— æƒè®¿é—®æ„é€ æ–¹æ³•");  
        }  
    }  
  
    // static å…³é”®å­—æ˜¯ä¸ºäº†ä½¿å•ä¾‹çš„ç©ºé—´å…±äº«ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•ä¸ä¼šè¢«é‡å†™ã€é‡è½½  
    public static LazyStaticInnerSingleton getInstance() {  
        // åœ¨ç»“æœè¿”å›ä¹‹å‰ï¼Œä¸€å®šä¼šå…ˆåŠ è½½å†…éƒ¨ç±»  
        return LazyHolder.INSTANCE;  
    }  
  
    private Object readResolve() {  
        return LazyHolder.INSTANCE;  
    }  
  
    // é»˜è®¤ä¸åŠ è½½  
    private static class LazyHolder {  
        private static final LazyStaticInnerSingleton INSTANCE = new LazyStaticInnerSingleton();  
    }  
}
```

é€šè¿‡ JDk æºç åˆ†æï¼Œ**è™½ç„¶å¢åŠ  `readResolve()` æ–¹æ³•è¿”å›å®ä¾‹è§£å†³äº†å•ä¾‹æ¨¡å¼è¢«ç ´åçš„é—®é¢˜**ï¼Œä½†æ˜¯ **å®é™…ä¸Šå®ä¾‹åŒ–äº†ä¸¤æ¬¡ï¼Œåªä¸è¿‡æ–°åˆ›å»ºçš„å¯¹è±¡æ²¡æœ‰è¢«è¿”å›è€Œå·²**ã€‚å¦‚æœåˆ›å»ºå¯¹è±¡çš„åŠ¨ä½œå‘ç”Ÿé¢‘ç‡åŠ å¿«ï¼Œå°±æ„å‘³ç€å†…å­˜åˆ†é…å¼€é”€ä¹Ÿä¼šéšä¹‹å¢å¤§ï¼Œéš¾é“çœŸçš„å°±æ²¡åŠæ³•ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜å—ï¼Ÿè¯·çœ‹ä¸‹é¢çš„ **æ³¨å†Œå¼å•ä¾‹æ¨¡å¼**ã€‚

### 4.7. 7ã€æ³¨å†Œå¼å•ä¾‹æ¨¡å¼

**æ³¨å†Œå¼å•ä¾‹æ¨¡å¼** åˆç§°ä¸ºç™»è®°å¼å•ä¾‹æ¨¡å¼ï¼Œå°±æ˜¯ **å°†æ¯ä¸€ä¸ªå®ä¾‹éƒ½ç™»è®°åˆ°æŸä¸€ä¸ªåœ°æ–¹ï¼Œä½¿ç”¨å”¯ä¸€çš„æ ‡è¯†è·å–å®ä¾‹**ã€‚æ³¨å†Œå¼å•ä¾‹æ¨¡å¼æœ‰ä¸¤ç§ï¼šä¸€ç§ä¸º **æšä¸¾å¼å•ä¾‹æ¨¡å¼**ï¼Œå¦ä¸€ç§ä¸º **å®¹å™¨å¼å•ä¾‹æ¨¡å¼**ã€‚

#### 4.7.1. 1ã€æšä¸¾å¼å•ä¾‹æ¨¡å¼

```java
public enum EnumSingleton {  
    INSTANCE;  
  
    private Object data;  
  
    public static EnumSingleton getInstance() {  
        return INSTANCE;  
    }  
  
    public Object getData() {  
        return data;  
    }  
  
    public void setData(Object data) {  
        this.data = data;  
    }  
}
```

æµ‹è¯•ç±»ä»£ç ï¼š

```java
public class EnumSingletonTest {  
    @Test  
    public void test() {  
        try {  
            EnumSingleton s1 = null;  
            EnumSingleton s2 = EnumSingleton.getInstance();  
            s2.setData(new Object());  
  
            FileOutputStream fos = new FileOutputStream("EnumSingleton.obj");  
            ObjectOutputStream oos = new ObjectOutputStream(fos);  
            oos.writeObject(s2);  
            oos.flush();  
            oos.close();  
  
            FileInputStream fis = new FileInputStream("EnumSingleton.obj");  
            ObjectInputStream ois = new ObjectInputStream(fis);  
            s1 = (EnumSingleton) ois.readObject();  
            ois.close();  
  
            System.out.println(s1.getData());  
            System.out.println(s2.getData());  
            System.out.println(s1.getData() == s2.getData());  
        } catch (Exception e) {  
            throw new RuntimeException(e);  
        }  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š  
![|400](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005212.png)  
 æ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œå‘ç°æµ‹è¯•çš„ç»“æœå’Œé¢„æœŸä¸€æ ·ã€‚æšä¸¾å¼å•ä¾‹æ¨¡å¼å¦‚æ­¤ç¥å¥‡ï¼Œå®ƒçš„ç¥å¥‡ä¹‹å¤„åœ¨å“ªé‡Œä½“ç°å‘¢ï¼Ÿ  
ä½¿ç”¨ Java åç¼–è¯‘å·¥å…· Jad => EnumSingleton.Jad æ–‡ä»¶ï¼š

```java
static {
	INSTANCE = new EnumSingleton("INSTANCE", 0);
	$VALUES = (new EnumSingleton[] {INSTANCE});
} 
```

åŸæ¥ï¼Œæšä¸¾å¼å•ä¾‹æ¨¡å¼åœ¨é™æ€ä»£ç å—ä¸­å°±ç»™ INSTANCE è¿›è¡Œäº†èµ‹å€¼ï¼Œæ˜¯é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼çš„å®ç°ã€‚  
Qï¼šåºåˆ—åŒ–èƒ½å¦ç ´åæšä¸¾ç±»å•ä¾‹æ¨¡å¼å‘¢ï¼Ÿ  
Aï¼šä¸å¦¨æ¥çœ‹ä¸‹ JDK æºç ï¼Œå›åˆ° `ObjectInputStream` çš„ `readObject0()` æ–¹æ³•ã€‚

```java
private Object readObject0(boolean unshared) throws IOException {
	...
	case TC_ENUM:  
	    return checkResolve(readEnum(unshared));
    ...
}
```

åœ¨ `readObject0()` æ–¹æ³•ä¸­è°ƒç”¨äº† `readEnum()` æ–¹æ³•ã€‚

```java
private Enum<?> readEnum(boolean unshared) throws IOException {  
    if (bin.readByte() != TC_ENUM) {  
        throw new InternalError();  
    }  
  
    ObjectStreamClass desc = readClassDesc(false);  
    if (!desc.isEnum()) {  
        throw new InvalidClassException("non-enum class: " + desc);  
    }  
  
    int enumHandle = handles.assign(unshared ? unsharedMarker : null);  
    ClassNotFoundException resolveEx = desc.getResolveException();  
    if (resolveEx != null) {  
        handles.markException(enumHandle, resolveEx);  
    }  
  
    String name = readString(false);  
    Enum<?> result = null;  
    Class<?> cl = desc.forClass();  
    if (cl != null) {  
        try {  
            @SuppressWarnings("unchecked")  
            Enum<?> en = Enum.valueOf((Class)cl, name);  
            result = en;  
        } catch (IllegalArgumentException ex) {  
            throw (IOException) new InvalidObjectException(  
                "enum constant " + name + " does not exist in " +  
                cl).initCause(ex);  
        }  
        if (!unshared) {  
            handles.setObject(enumHandle, result);  
        }  
    }  
  
    handles.finish(enumHandle);  
    passHandle = enumHandle;  
    return result;  
}
```

æšä¸¾ç±»å‹å…¶å®é€šè¿‡ç±»åå’Œç±»å¯¹è±¡æ‰¾åˆ°ä¸€ä¸ªå”¯ä¸€çš„æšä¸¾å¯¹è±¡ã€‚å› æ­¤ï¼Œæšä¸¾å¯¹è±¡ä¸å¯èƒ½è¢«ç±»åŠ è½½å™¨åŠ è½½å¤šæ¬¡ã€‚  
Qï¼šåå°„æ˜¯å¦èƒ½ç ´åæšä¸¾å¼å•ä¾‹æ¨¡å¼å‘¢ï¼Ÿ  
Aï¼šå…ˆæ¥çœ‹ä¸€æ®µæµ‹è¯•ä»£ç ï¼š

```java
@Test  
public void test1() {  
    try {  
        Class<EnumSingleton> clazz = EnumSingleton.class;  
        Constructor<EnumSingleton> constructor = clazz.getDeclaredConstructor();  
        EnumSingleton enumSingleton = constructor.newInstance();  
    } catch (Exception e) {  
        throw new RuntimeException(e);  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š  
![|1000](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005487.png)  
ç»“æœä¸­æŠ¥çš„æ˜¯ `java.lang.NoSuchMethodException` å¼‚å¸¸ï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°æ— å‚çš„æ„é€ æ–¹æ³•ã€‚æ­¤æ—¶ï¼ŒæŸ¥çœ‹ `java.lang.Enum` çš„æ„é€ æ–¹æ³•ï¼Œå‘ç°åªæœ‰ä¸€ä¸ª `protected` ç±»å‹çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
protected Enum(String name, int ordinal) {  
    this.name = name;  
    this.ordinal = ordinal;  
}
```

ä¿®æ”¹ä¸€ä¸‹æµ‹è¯•ç±»ï¼š

```java
@Test  
public void test1() {  
    try {  
        Class<EnumSingleton> clazz = EnumSingleton.class;  
        Constructor<EnumSingleton> constructor = clazz.getDeclaredConstructor(String.class, int.class);  
        constructor.setAccessible(true);  
        EnumSingleton enumSingleton = constructor.newInstance("xiaorang", 666);  
    } catch (Exception e) {  
        throw new RuntimeException(e);  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š  
![|800](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005216.png)  
è¿™æ—¶é”™è¯¯å·²ç»å¾ˆæ˜æ˜¾ï¼Œ"Cannot reflectively create enum objects"ï¼Œ**ä¸èƒ½ä½¿ç”¨åå°„æ¥åˆ›å»ºæšä¸¾ç±»å‹**ã€‚æŸ¥çœ‹ä¸€ä¸‹ Constructor ä¸­çš„ newInstance() æ–¹æ³•ï¼š

```java
public T newInstance(Object ... initargs)  
    throws InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException  â€‹{  
    if (!override) {  
        if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) {  
            Class<?> caller = Reflection.getCallerClass();  
            checkAccess(caller, clazz, null, modifiers);  
        }  
    }  
    if ((clazz.getModifiers() & Modifier.ENUM) != 0)  
        throw new IllegalArgumentException("Cannot reflectively create enum objects");  
    ConstructorAccessor ca = constructorAccessor;   // read volatile  
    if (ca == null) {  
        ca = acquireConstructorAccessor();  
    }  
    @SuppressWarnings("unchecked")  
    T inst = (T) ca.newInstance(initargs);  
    return inst;  
}
```

ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ `newInstance()` æ–¹æ³•ä¸­åšäº†å¼ºåˆ¶æ€§çš„åˆ¤æ–­ï¼Œå¦‚æœä¿®é¥°ç¬¦æ˜¯ `Modifier.ENUM` æšä¸¾ç±»å‹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚  
æšä¸¾å¼å•ä¾‹æ¨¡å¼ä¹Ÿæ˜¯ Effective Java ä¹¦ä¸­æ¨èçš„ä¸€ç§å•ä¾‹æ¨¡å¼å®ç°å†™æ³•ã€‚JDK æšä¸¾çš„è¯­æ³•ç‰¹æ®Šæ€§ä»¥åŠåå°„ä¹Ÿä¸ºæšä¸¾ä¿é©¾æŠ¤èˆªï¼Œè®©æšä¸¾å¼å•ä¾‹æ¨¡å¼æˆä¸ºä¸€ç§æ¯”è¾ƒä¼˜é›…çš„å®ç°ã€‚

#### 4.7.2. 2ã€å®¹å™¨å¼å•ä¾‹æ¨¡å¼

```java
public class ContainerSingleton {  
    private static Map<String, Object> ioc = new ConcurrentHashMap<>();  
  
    private ContainerSingleton() {  
    }  
    public static Object getBean(String className) {  
        synchronized (ioc) {  
            if (!ioc.containsKey(className)) {  
                Object obj = null;  
                try {  
                    Class<?> clazz = Class.forName(className);  
                    obj = clazz.newInstance();  
                    ioc.put(className, obj);  
                } catch (Exception e) {  
                    throw new RuntimeException(e);  
                }  
                return obj;  
            }  
            return ioc.get(className);  
        }  
    }  
}  
  
class A {  
  
}
```

æµ‹è¯•ç±»ä»£ç å¦‚ä¸‹ï¼š

```java
public class ContainerSingletonTest {  
    @Test  
    public void test() {  
        Runnable runnable = () -> {  
            A bean = (A) ContainerSingleton.getBean("top.xiaorang.design.pattern.singleton.A");  
            System.out.println(bean);  
        };  
        Thread t1 = new Thread(runnable);  
        Thread t2 = new Thread(runnable);  
        t1.start();  
        t2.start();  
        System.out.println("å¼€å§‹æ‰§è¡Œ...");  
    }  
}
```

å®¹å™¨å¼å•ä¾‹æ¨¡å¼é€‚åˆå®ä¾‹éå¸¸å¤šçš„æƒ…å†µï¼Œä¾¿äºç®¡ç†ã€‚å†æ¥çœ‹çœ‹ **Spring ä¸­å®¹å™¨å¼å•ä¾‹æ¨¡å¼** çš„å®ç°ä»£ç ï¼š

```java
public abstract class AbstractAutowireCapableBeanFactory extends AbstractBeanFactory  
      implements AutowireCapableBeanFactory {
	/** Cache of unfinished FactoryBean instances: FactoryBean name to BeanWrapper. */  
	private final ConcurrentMap<String, BeanWrapper> factoryBeanInstanceCache = new ConcurrentHashMap<>();
}
```

### 4.8. 8ã€çº¿ç¨‹å•ä¾‹å®ç° ThreadLocal

```java
public class ThreadLocalSingleton {  
    private static final ThreadLocal<ThreadLocalSingleton> threadLocalInstance = new ThreadLocal<ThreadLocalSingleton>() {  
        @Override  
        protected ThreadLocalSingleton initialValue() {  
            return new ThreadLocalSingleton();  
        }  
    };  
  
    private ThreadLocalSingleton() {  
    }  
    public static ThreadLocalSingleton getInstance() {  
        return threadLocalInstance.get();  
    }  
}
```

æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```java
public class ThreadLocalSingletonTest {  
    @Test  
    public void test() {  
        System.out.println(ThreadLocalSingleton.getInstance());  
        System.out.println(ThreadLocalSingleton.getInstance());  
        System.out.println(ThreadLocalSingleton.getInstance());  
        System.out.println(ThreadLocalSingleton.getInstance());  
        System.out.println(ThreadLocalSingleton.getInstance());  
  
        Runnable runnable = () -> {  
            ThreadLocalSingleton instance = ThreadLocalSingleton.getInstance();  
            System.out.println(Thread.currentThread().getName() + ":" + instance);  
        };  
        Thread t1 = new Thread(runnable);  
        Thread t2 = new Thread(runnable);  
        t1.start();  
        t2.start();  
        System.out.println("å¼€å§‹æ‰§è¡Œ...");  
    }  
}
```

æµ‹è¯•ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š  
![|600](https://fastly.jsdelivr.net/gh/xihuanxiaorang/images/202211140005659.png)  
**ThreadLocal** ä¸èƒ½ä¿è¯å…¶åˆ›å»ºçš„å¯¹è±¡æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œä½†æ˜¯ **èƒ½ä¿è¯åœ¨å•ä¸ªçº¿ç¨‹ä¸­æ˜¯å”¯ä¸€çš„**ï¼Œå¤©ç”Ÿæ˜¯ **çº¿ç¨‹å®‰å…¨** çš„ã€‚  
åœ¨ä¸»çº¿ç¨‹ä¸­æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡ï¼Œè·å–åˆ°çš„å®ä¾‹éƒ½æ˜¯åŒä¸€ä¸ªï¼Œéƒ½åœ¨ä¸¤ä¸ªå­çº¿ç¨‹ä¸­åˆ†åˆ«è·å–åˆ°äº†ä¸åŒçš„å®ä¾‹ã€‚  
Qï¼šThreadLocal æ˜¯å¦‚ä½•å®ç°è¿™æ ·çš„æ•ˆæœçš„å‘¢ï¼Ÿ  
Aï¼šå•ä¾‹æ¨¡å¼ä¸ºäº†è¾¾åˆ°çº¿ç¨‹å®‰å…¨çš„ç›®çš„ï¼Œä¼šç»™æ–¹æ³•ä¸Šé” ï¼Œä»¥æ—¶é—´æ¢ç©ºé—´ã€‚**ThreadLocal å°†æ‰€æœ‰çš„å¯¹è±¡å…¨éƒ¨æ”¾åœ¨ ThreadLocalMap ä¸­ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›ä¸€ä¸ªå¯¹è±¡**ï¼Œå®é™…ä¸Šæ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´æ¥å®ç°çº¿ç¨‹éš”ç¦»çš„ã€‚
